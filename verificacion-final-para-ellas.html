<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificación Final - Para Ellas vs Para Ellos</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/para_ellas.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f8f9fa;
        }
        .test-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .comparison-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .side-by-side {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 20px 0;
        }
        .section-title {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .debug-info {
            background: #f1f3f4;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            border-left: 4px solid #1976d2;
        }
        .status-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
        }
        .status-success { background: #d4edda; color: #155724; }
        .status-warning { background: #fff3cd; color: #856404; }
        .status-error { background: #f8d7da; color: #721c24; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #1976d2;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🔍 Verificación Final: Para Ellas vs Para Ellos</h1>
        
        <div class="comparison-section">
            <h2>📊 Estadísticas de Carga</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="ellasTotalCount">-</div>
                    <div>Productos Para Ellas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="ellosTotalCount">-</div>
                    <div>Productos Para Ellos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="ellasImagesOk">-</div>
                    <div>Imágenes OK (Ellas)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="ellosImagesOk">-</div>
                    <div>Imágenes OK (Ellos)</div>
                </div>
            </div>
        </div>

        <div class="comparison-section">
            <h2>🔄 Estado de Carga</h2>
            <div id="loadingStatus" class="debug-info">
                <span class="status-indicator status-warning">CARGANDO</span>
                Inicializando verificación...
            </div>
        </div>

        <div class="comparison-section">
            <h2>🎨 Comparación Visual de Tarjetas</h2>
            <div class="side-by-side">
                <div>
                    <h3 class="section-title">Para Ellas (Primeros 4 productos)</h3>
                    <div id="ellasPreview" class="products-grid">
                        <div class="loading">Cargando productos para ellas...</div>
                    </div>
                </div>
                <div>
                    <h3 class="section-title">Para Ellos (Primeros 4 productos)</h3>
                    <div id="ellosPreview" class="products-grid">
                        <div class="loading">Cargando productos para ellos...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="comparison-section">
            <h2>🔧 Análisis Técnico</h2>
            <div id="technicalAnalysis" class="debug-info">
                Analizando estructuras de tarjetas...
            </div>
        </div>
    </div>

    <!-- Scripts necesarios -->
    <script src="js/supabase-config.js"></script>
    <script>
        class VerificacionFinal {
            constructor() {
                this.ellasData = null;
                this.ellosData = null;
                this.init();
            }

            async init() {
                this.updateStatus('Iniciando verificación...', 'warning');
                
                try {
                    // Verificar dependencias
                    if (typeof ProductosService === 'undefined') {
                        throw new Error('ProductosService no disponible');
                    }

                    // Cargar datos en paralelo
                    this.updateStatus('Cargando productos desde la base de datos...', 'warning');
                    
                    const [ellasResult, ellosResult] = await Promise.all([
                        ProductosService.obtenerProductosPorCategoria('para-ellas'),
                        ProductosService.obtenerProductosPorCategoria('para-ellos')
                    ]);

                    this.ellasData = ellasResult;
                    this.ellosData = ellosResult;

                    this.updateStatus('Datos cargados exitosamente', 'success');
                    
                    // Realizar análisis
                    await this.performAnalysis();
                    
                } catch (error) {
                    console.error('Error en verificación:', error);
                    this.updateStatus(`Error: ${error.message}`, 'error');
                }
            }

            updateStatus(message, type = 'warning') {
                const statusEl = document.getElementById('loadingStatus');
                const typeClass = `status-${type}`;
                statusEl.innerHTML = `<span class="status-indicator ${typeClass}">${type.toUpperCase()}</span>${message}`;
            }

            async performAnalysis() {
                // Actualizar estadísticas
                document.getElementById('ellasTotalCount').textContent = this.ellasData.length;
                document.getElementById('ellosTotalCount').textContent = this.ellosData.length;

                // Renderizar previews
                await this.renderPreviews();

                // Análisis técnico
                this.performTechnicalAnalysis();

                this.updateStatus('Verificación completada exitosamente', 'success');
            }

            async renderPreviews() {
                const ellasContainer = document.getElementById('ellasPreview');
                const ellosContainer = document.getElementById('ellosPreview');

                // Tomar los primeros 4 productos de cada categoría
                const ellasPreview = this.ellasData.slice(0, 4);
                const ellosPreview = this.ellosData.slice(0, 4);

                // Renderizar Para Ellas
                ellasContainer.innerHTML = ellasPreview.map(product => 
                    this.createMiniCard(product, 'ellas')
                ).join('');

                // Renderizar Para Ellos
                ellosContainer.innerHTML = ellosPreview.map(product => 
                    this.createMiniCard(product, 'ellos')
                ).join('');

                // Verificar imágenes después de renderizar
                setTimeout(() => {
                    this.checkImages();
                }, 1000);
            }

            createMiniCard(product, category) {
                const imageSrc = this.getImagePath(product.imagen_url || product.imagen);
                const precio = this.formatPrice(product.precio);
                
                return `
                    <div class="index-item mini-card" data-category="${category}" data-product-id="${product.id}">
                        <div class="item-image">
                            <img src="${imageSrc}" 
                                 alt="${product.nombre}"
                                 loading="lazy"
                                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2Y1ZjVmNSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkb21pbmFudC1iYXNlbGluZT0iY2VudHJhbCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzk5OSI+SW1hZ2VuIG5vIGRpc3BvbmlibGU8L3RleHQ+PC9zdmc+';">
                        </div>
                        <div class="item-content">
                            <h3 class="item-title">${product.nombre}</h3>
                            <p class="item-size">${product.ml || 100} ML</p>
                            <div class="item-price">$${precio}</div>
                        </div>
                    </div>
                `;
            }

            checkImages() {
                const ellasImages = document.querySelectorAll('[data-category="ellas"] img');
                const ellosImages = document.querySelectorAll('[data-category="ellos"] img');

                let ellasOk = 0;
                let ellosOk = 0;

                ellasImages.forEach(img => {
                    if (img.naturalWidth > 0 && img.naturalHeight > 0) {
                        ellasOk++;
                    }
                });

                ellosImages.forEach(img => {
                    if (img.naturalWidth > 0 && img.naturalHeight > 0) {
                        ellosOk++;
                    }
                });

                document.getElementById('ellasImagesOk').textContent = `${ellasOk}/${ellasImages.length}`;
                document.getElementById('ellosImagesOk').textContent = `${ellosOk}/${ellosImages.length}`;
            }

            performTechnicalAnalysis() {
                const analysis = [];

                // Comparar estructura de datos
                if (this.ellasData.length > 0 && this.ellosData.length > 0) {
                    const ellasKeys = Object.keys(this.ellasData[0]).sort();
                    const ellosKeys = Object.keys(this.ellosData[0]).sort();
                    
                    const keysMatch = JSON.stringify(ellasKeys) === JSON.stringify(ellosKeys);
                    analysis.push(`✅ Estructura de datos: ${keysMatch ? 'IDÉNTICA' : 'DIFERENTE'}`);
                    
                    if (!keysMatch) {
                        analysis.push(`   Para Ellas: ${ellasKeys.join(', ')}`);
                        analysis.push(`   Para Ellos: ${ellosKeys.join(', ')}`);
                    }
                }

                // Verificar campos de imagen
                const ellasImageFields = this.ellasData.map(p => ({
                    id: p.id,
                    imagen: p.imagen,
                    imagen_url: p.imagen_url,
                    hasImage: !!(p.imagen || p.imagen_url)
                }));

                const ellosImageFields = this.ellosData.map(p => ({
                    id: p.id,
                    imagen: p.imagen,
                    imagen_url: p.imagen_url,
                    hasImage: !!(p.imagen || p.imagen_url)
                }));

                const ellasWithImages = ellasImageFields.filter(p => p.hasImage).length;
                const ellosWithImages = ellosImageFields.filter(p => p.hasImage).length;

                analysis.push(`📊 Productos con imágenes:`);
                analysis.push(`   Para Ellas: ${ellasWithImages}/${this.ellasData.length} (${Math.round(ellasWithImages/this.ellasData.length*100)}%)`);
                analysis.push(`   Para Ellos: ${ellosWithImages}/${this.ellosData.length} (${Math.round(ellosWithImages/this.ellosData.length*100)}%)`);

                // Mostrar ejemplos de rutas de imagen
                if (this.ellasData.length > 0) {
                    const firstEllas = this.ellasData[0];
                    analysis.push(`🖼️ Ejemplo imagen Para Ellas: ${firstEllas.imagen_url || firstEllas.imagen || 'Sin imagen'}`);
                }

                if (this.ellosData.length > 0) {
                    const firstEllos = this.ellosData[0];
                    analysis.push(`🖼️ Ejemplo imagen Para Ellos: ${firstEllos.imagen_url || firstEllos.imagen || 'Sin imagen'}`);
                }

                document.getElementById('technicalAnalysis').innerHTML = analysis.join('<br>');
            }

            getImagePath(imagePath) {
                if (!imagePath) return 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2Y1ZjVmNSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkb21pbmFudC1iYXNlbGluZT0iY2VudHJhbCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzk5OSI+U2luIGltYWdlbjwvdGV4dD48L3N2Zz4=';
                
                imagePath = imagePath.trim();
                
                if (imagePath.startsWith('http://') || imagePath.startsWith('https://')) {
                    return imagePath;
                }
                
                if (imagePath.startsWith('data:image/')) {
                    return imagePath;
                }
                
                if (imagePath.startsWith('../')) {
                    return imagePath;
                }
                
                return `../${imagePath}`;
            }

            formatPrice(price) {
                return new Intl.NumberFormat('es-CO', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(price);
            }
        }

        // Inicializar cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', () => {
            new VerificacionFinal();
        });
    </script>
</body>
</html>
