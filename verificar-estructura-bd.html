<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificar Estructura BD</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            color: #155724;
            background: #d4edda;
            padding: 10px;
            border-radius: 4px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .column-info {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>Verificar Estructura Real de Base de Datos</h1>
    
    <div class="test-section">
        <h2>Estado de Conexión</h2>
        <div id="connectionStatus" class="loading">Conectando...</div>
    </div>
    
    <div class="test-section">
        <h2>Estructura de Tabla 'productos'</h2>
        <div id="tableStructure" class="loading">Consultando estructura...</div>
    </div>
    
    <div class="test-section">
        <h2>Muestra de Productos (primeros 5)</h2>
        <div id="sampleProducts" class="loading">Cargando muestra...</div>
    </div>
    
    <div class="test-section">
        <h2>Campos de Imagen Encontrados</h2>
        <div id="imageFields" class="loading">Analizando campos...</div>
    </div>

    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        // Configuración de Supabase
        const SUPABASE_URL = 'https://xelobsbzytdxrrxgmlta.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhlbG9ic2J6eXRkeHJyeGdtbHRhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAzODUzNTksImV4cCI6MjA2NTk2MTM1OX0.bJL5DsL4pxlQ_FV3jX0ieiW3bYLA-Zf3M2HlNmdMMy4';
        
        let supabaseClient = null;

        // Inicializar Supabase
        function initSupabase() {
            try {
                if (typeof window !== 'undefined' && window.supabase && SUPABASE_URL && SUPABASE_ANON_KEY) {
                    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    window.supabaseClient = supabaseClient;
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Error inicializando Supabase:', error);
                return false;
            }
        }

        // Verificar conexión
        async function checkConnection() {
            const statusDiv = document.getElementById('connectionStatus');
            
            try {
                const initialized = initSupabase();
                if (!initialized) {
                    statusDiv.innerHTML = '<div class="error">No se pudo inicializar Supabase</div>';
                    return false;
                }
                
                // Probar conexión
                const { data, error } = await supabaseClient.from('productos').select('id').limit(1);
                
                if (error) {
                    statusDiv.innerHTML = `<div class="error">Error de conexión: ${error.message}</div>`;
                    return false;
                }
                
                statusDiv.innerHTML = '<div class="success">✅ Conectado correctamente</div>';
                return true;
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
                return false;
            }
        }

        // Obtener estructura de tabla
        async function getTableStructure() {
            const container = document.getElementById('tableStructure');
            
            try {
                // Obtener información de columnas usando PostgreSQL system catalogs
                const { data, error } = await supabaseClient
                    .rpc('get_table_columns', { table_name: 'productos' })
                    .select('*');
                
                if (error) {
                    console.log('RPC no disponible, usando consulta directa...');
                    
                    // Fallback: obtener un producto y analizar sus campos
                    const { data: sampleData, error: sampleError } = await supabaseClient
                        .from('productos')
                        .select('*')
                        .limit(1);
                    
                    if (sampleError) {
                        container.innerHTML = `<div class="error">Error obteniendo estructura: ${sampleError.message}</div>`;
                        return;
                    }
                    
                    if (sampleData && sampleData.length > 0) {
                        const product = sampleData[0];
                        const fields = Object.keys(product).map(key => ({
                            column_name: key,
                            data_type: typeof product[key],
                            is_nullable: product[key] === null ? 'YES' : 'NO',
                            column_default: product[key],
                            sample_value: product[key]
                        }));
                        
                        const structureHTML = `
                            <div class="column-info">
                                <strong>Estructura inferida desde muestra de datos:</strong>
                                <pre>${JSON.stringify(fields, null, 2)}</pre>
                            </div>
                        `;
                        
                        container.innerHTML = structureHTML;
                    } else {
                        container.innerHTML = '<div class="error">No se encontraron productos para analizar</div>';
                    }
                    
                } else {
                    const structureHTML = `
                        <div class="column-info">
                            <strong>Estructura de tabla 'productos':</strong>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                    
                    container.innerHTML = structureHTML;
                }
                
            } catch (error) {
                container.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // Obtener muestra de productos
        async function getSampleProducts() {
            const container = document.getElementById('sampleProducts');
            
            try {
                const { data, error } = await supabaseClient
                    .from('productos')
                    .select('*')
                    .limit(5);
                
                if (error) {
                    container.innerHTML = `<div class="error">Error: ${error.message}</div>`;
                    return;
                }
                
                if (!data || data.length === 0) {
                    container.innerHTML = '<div class="error">No se encontraron productos</div>';
                    return;
                }
                
                const sampleHTML = `
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
                
                container.innerHTML = sampleHTML;
                
                // Analizar campos de imagen
                analyzeImageFields(data);
                
            } catch (error) {
                container.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // Analizar campos de imagen
        function analyzeImageFields(products) {
            const container = document.getElementById('imageFields');
            
            if (!products || products.length === 0) {
                container.innerHTML = '<div class="error">No hay productos para analizar</div>';
                return;
            }
            
            // Buscar todos los campos que podrían contener imágenes
            const imageFields = [];
            const firstProduct = products[0];
            
            Object.keys(firstProduct).forEach(key => {
                if (key.toLowerCase().includes('imagen') || 
                    key.toLowerCase().includes('image') || 
                    key.toLowerCase().includes('foto') || 
                    key.toLowerCase().includes('picture')) {
                    imageFields.push(key);
                }
            });
            
            // Analizar contenido de cada campo de imagen
            const fieldAnalysis = imageFields.map(field => {
                const values = products.map(p => p[field]);
                const types = values.map(v => typeof v);
                const nonNullValues = values.filter(v => v !== null && v !== undefined);
                
                return {
                    field,
                    totalValues: values.length,
                    nonNullValues: nonNullValues.length,
                    types: [...new Set(types)],
                    sampleValues: nonNullValues.slice(0, 3),
                    hasStringValues: nonNullValues.some(v => typeof v === 'string' && v.trim() !== '')
                };
            });
            
            const analysisHTML = `
                <div class="column-info">
                    <strong>Campos de imagen encontrados:</strong>
                    <pre>${JSON.stringify(fieldAnalysis, null, 2)}</pre>
                    
                    <div style="margin-top: 15px;">
                        <strong>Resumen:</strong>
                        <ul>
                            ${fieldAnalysis.map(fa => `
                                <li>
                                    <strong>${fa.field}:</strong> 
                                    ${fa.nonNullValues}/${fa.totalValues} con valores, 
                                    tipos: ${fa.types.join(', ')}, 
                                    ${fa.hasStringValues ? '✅ Tiene valores string válidos' : '❌ Sin valores string válidos'}
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                </div>
            `;
            
            container.innerHTML = analysisHTML;
        }

        // Ejecutar verificaciones
        document.addEventListener('DOMContentLoaded', async function() {
            const connected = await checkConnection();
            if (connected) {
                await getTableStructure();
                await getSampleProducts();
            }
        });
    </script>
</body>
</html>
