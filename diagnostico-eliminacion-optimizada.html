<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico - Optimizaci√≥n de Eliminaci√≥n</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1000px; 
            margin: 0 auto; 
            padding: 20px; 
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-title {
            color: #333;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button.danger {
            background-color: #dc3545;
        }
        button.danger:hover {
            background-color: #c82333;
        }
        button.success {
            background-color: #28a745;
        }
        button.success:hover {
            background-color: #218838;
        }
        .console-log {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 15px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .product-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
        }
        .product-card h4 {
            margin: 5px 0;
            font-size: 14px;
        }
        .product-card button {
            font-size: 12px;
            padding: 5px 8px;
        }
        .timing-info {
            background-color: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 class="test-title">üîß Diagn√≥stico - Optimizaci√≥n de Eliminaci√≥n</h1>
        <div id="status" class="status info">
            Preparando diagn√≥stico...
        </div>
    </div>

    <!-- Controles de diagn√≥stico -->
    <div class="test-container">
        <h2>Controles de Diagn√≥stico</h2>
        <div class="button-group">
            <button onclick="testNormalReload()">üì¶ Recarga Normal</button>
            <button onclick="testFastReload()" class="success">‚ö° Recarga R√°pida</button>
            <button onclick="compareReloadMethods()" class="success">‚öñÔ∏è Comparar M√©todos</button>
            <button onclick="createTestProduct()">‚ûï Crear Producto de Prueba</button>
            <button onclick="deleteLastProduct()" class="danger">üóëÔ∏è Eliminar √öltimo Producto</button>
            <button onclick="simulateDeleteProcess()" class="danger">üîÑ Simular Proceso Completo</button>
            <button onclick="clearConsole()">üßπ Limpiar Console</button>
        </div>
        
        <div class="timing-info" id="timingInfo">
            Tiempos de ejecuci√≥n aparecer√°n aqu√≠...
        </div>
    </div>

    <!-- Lista de productos para testing -->
    <div class="test-container">
        <h2>Productos Disponibles para Testing</h2>
        <button onclick="loadProductsForTesting()">üîÑ Cargar Productos</button>
        <div id="productsForTesting" class="products-grid">
            <!-- Productos aparecer√°n aqu√≠ -->
        </div>
    </div>

    <!-- Console de resultados -->
    <div class="test-container">
        <h2>Console de Resultados</h2>
        <div class="console-log" id="console"></div>
    </div>

    <!-- Scripts necesarios -->
    <script src="js/supabase-config.js"></script>
    <script src="js/admin-panel-new.js"></script>

    <script>
        // Variables globales
        let adminPanel;
        let testProducts = [];

        // Inicializar cuando se cargue la p√°gina
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                logToConsole('üîß Iniciando diagn√≥stico de optimizaci√≥n de eliminaci√≥n...');
                
                // Verificar que Supabase est√© configurado
                if (typeof supabase === 'undefined') {
                    throw new Error('Supabase no est√° configurado');
                }
                
                // Crear instancia del panel de admin
                adminPanel = new AdminPanel();
                
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                updateStatus('‚úÖ Diagn√≥stico listo. Panel de admin inicializado.', 'success');
                logToConsole('‚úÖ Panel de administraci√≥n listo para testing');
                
            } catch (error) {
                console.error('‚ùå Error inicializando diagn√≥stico:', error);
                updateStatus(`‚ùå Error: ${error.message}`, 'error');
                logToConsole(`‚ùå Error inicializando: ${error.message}`);
            }
        });

        // Funci√≥n para probar recarga normal
        async function testNormalReload() {
            logToConsole('üì¶ Probando recarga normal de productos...');
            const startTime = performance.now();
            
            try {
                await adminPanel.loadProductos();
                const endTime = performance.now();
                const duration = Math.round(endTime - startTime);
                
                logToConsole(`‚úÖ Recarga normal completada en ${duration}ms`);
                logToConsole(`üìä Productos cargados: ${adminPanel.productos.length}`);
                
                updateTimingInfo('normal', duration, adminPanel.productos.length);
                
            } catch (error) {
                const endTime = performance.now();
                const duration = Math.round(endTime - startTime);
                logToConsole(`‚ùå Error en recarga normal despu√©s de ${duration}ms: ${error.message}`);
                updateTimingInfo('normal', duration, 0, error.message);
            }
        }

        // Funci√≥n para probar recarga r√°pida
        async function testFastReload() {
            logToConsole('‚ö° Probando recarga r√°pida de productos...');
            const startTime = performance.now();
            
            try {
                await adminPanel.loadProductosRapido();
                const endTime = performance.now();
                const duration = Math.round(endTime - startTime);
                
                logToConsole(`‚úÖ Recarga r√°pida completada en ${duration}ms`);
                logToConsole(`üìä Productos cargados: ${adminPanel.productos.length}`);
                
                updateTimingInfo('fast', duration, adminPanel.productos.length);
                
            } catch (error) {
                const endTime = performance.now();
                const duration = Math.round(endTime - startTime);
                logToConsole(`‚ùå Error en recarga r√°pida despu√©s de ${duration}ms: ${error.message}`);
                updateTimingInfo('fast', duration, 0, error.message);
            }
        }

        // Funci√≥n para comparar m√©todos
        async function compareReloadMethods() {
            logToConsole('‚öñÔ∏è Comparando m√©todos de recarga...');
            
            const results = {
                normal: { duration: 0, products: 0, error: null },
                fast: { duration: 0, products: 0, error: null }
            };

            // Probar m√©todo normal
            logToConsole('üì¶ Probando m√©todo normal...');
            let startTime = performance.now();
            try {
                await adminPanel.loadProductos();
                results.normal.duration = Math.round(performance.now() - startTime);
                results.normal.products = adminPanel.productos.length;
            } catch (error) {
                results.normal.duration = Math.round(performance.now() - startTime);
                results.normal.error = error.message;
            }

            // Esperar un poco entre pruebas
            await new Promise(resolve => setTimeout(resolve, 1000));

            // Probar m√©todo r√°pido
            logToConsole('‚ö° Probando m√©todo r√°pido...');
            startTime = performance.now();
            try {
                await adminPanel.loadProductosRapido();
                results.fast.duration = Math.round(performance.now() - startTime);
                results.fast.products = adminPanel.productos.length;
            } catch (error) {
                results.fast.duration = Math.round(performance.now() - startTime);
                results.fast.error = error.message;
            }

            // Mostrar comparaci√≥n
            logToConsole('üìä Resultados de comparaci√≥n:');
            logToConsole(`   Normal: ${results.normal.duration}ms, ${results.normal.products} productos, ${results.normal.error ? 'ERROR: ' + results.normal.error : 'OK'}`);
            logToConsole(`   R√°pido: ${results.fast.duration}ms, ${results.fast.products} productos, ${results.fast.error ? 'ERROR: ' + results.fast.error : 'OK'}`);
            
            if (!results.normal.error && !results.fast.error) {
                const improvement = Math.round(((results.normal.duration - results.fast.duration) / results.normal.duration) * 100);
                logToConsole(`üöÄ Mejora: ${improvement}% m√°s r√°pido con m√©todo optimizado`);
            }

            updateTimingInfo('comparison', 0, 0, null, results);
        }

        // Funci√≥n para crear producto de prueba
        async function createTestProduct() {
            logToConsole('‚ûï Creando producto de prueba para eliminaci√≥n...');
            
            try {
                const testProduct = {
                    nombre: `Test Delete ${new Date().getTime()}`,
                    marca: 'Test Brand',
                    precio: 25000,
                    categoria: 'prueba',
                    descripcion: 'Producto creado para probar eliminaci√≥n optimizada',
                    activo: true
                };

                const result = await adminPanel.saveProduct(testProduct);
                if (result) {
                    logToConsole(`‚úÖ Producto de prueba creado: ID ${result.id} - "${result.nombre}"`);
                    await loadProductsForTesting();
                } else {
                    logToConsole('‚ùå No se pudo crear el producto de prueba');
                }
                
            } catch (error) {
                logToConsole(`‚ùå Error creando producto de prueba: ${error.message}`);
            }
        }

        // Funci√≥n para eliminar √∫ltimo producto
        async function deleteLastProduct() {
            logToConsole('üóëÔ∏è Eliminando √∫ltimo producto para testing...');
            
            try {
                if (adminPanel.productos.length === 0) {
                    await adminPanel.loadProductos();
                }

                if (adminPanel.productos.length === 0) {
                    logToConsole('‚ùå No hay productos para eliminar');
                    return;
                }

                const lastProduct = adminPanel.productos[adminPanel.productos.length - 1];
                logToConsole(`üéØ Eliminando producto: ID ${lastProduct.id} - "${lastProduct.nombre}"`);

                const startTime = performance.now();
                await adminPanel.deleteProduct(lastProduct.id);
                const duration = Math.round(performance.now() - startTime);

                logToConsole(`‚úÖ Eliminaci√≥n completada en ${duration}ms`);
                updateTimingInfo('delete', duration, 0);

            } catch (error) {
                logToConsole(`‚ùå Error eliminando producto: ${error.message}`);
            }
        }

        // Funci√≥n para simular proceso completo de eliminaci√≥n
        async function simulateDeleteProcess() {
            logToConsole('üîÑ Simulando proceso completo de eliminaci√≥n...');
            
            try {
                // 1. Crear producto de prueba
                logToConsole('1Ô∏è‚É£ Creando producto de prueba...');
                const testProduct = {
                    nombre: `Test Complete ${new Date().getTime()}`,
                    marca: 'Complete Test',
                    precio: 15000,
                    categoria: 'prueba'
                };

                const created = await adminPanel.saveProduct(testProduct);
                if (!created) {
                    throw new Error('No se pudo crear producto de prueba');
                }

                logToConsole(`‚úÖ Producto creado: ID ${created.id}`);

                // 2. Esperar un poco
                await new Promise(resolve => setTimeout(resolve, 1000));

                // 3. Eliminar el producto y medir tiempo
                logToConsole('2Ô∏è‚É£ Eliminando producto...');
                const deleteStartTime = performance.now();
                
                await adminPanel.deleteProduct(created.id);
                
                const deleteDuration = Math.round(performance.now() - deleteStartTime);
                logToConsole(`‚úÖ Proceso completo de eliminaci√≥n en ${deleteDuration}ms`);

                updateTimingInfo('complete', deleteDuration, 0);

            } catch (error) {
                logToConsole(`‚ùå Error en simulaci√≥n completa: ${error.message}`);
            }
        }

        // Funci√≥n para cargar productos para testing
        async function loadProductsForTesting() {
            try {
                await adminPanel.loadProductos();
                const container = document.getElementById('productsForTesting');
                
                if (adminPanel.productos.length === 0) {
                    container.innerHTML = '<p>No hay productos disponibles</p>';
                    return;
                }

                const productsHTML = adminPanel.productos.slice(0, 10).map(product => `
                    <div class="product-card">
                        <h4>${product.nombre}</h4>
                        <p>ID: ${product.id}</p>
                        <p>${product.marca}</p>
                        <button onclick="testDeleteProduct(${product.id})" class="danger">
                            üóëÔ∏è Eliminar
                        </button>
                    </div>
                `).join('');

                container.innerHTML = productsHTML;
                logToConsole(`üì¶ ${adminPanel.productos.length} productos cargados para testing`);

            } catch (error) {
                logToConsole(`‚ùå Error cargando productos: ${error.message}`);
            }
        }

        // Funci√≥n para eliminar producto espec√≠fico
        async function testDeleteProduct(productId) {
            const producto = adminPanel.productos.find(p => p.id === productId);
            if (!producto) {
                logToConsole(`‚ùå Producto ID ${productId} no encontrado`);
                return;
            }

            if (!confirm(`¬øEliminar "${producto.nombre}"?`)) {
                return;
            }

            logToConsole(`üóëÔ∏è Eliminando producto ID ${productId} - "${producto.nombre}"`);
            
            try {
                const startTime = performance.now();
                await adminPanel.deleteProduct(productId);
                const duration = Math.round(performance.now() - startTime);
                
                logToConsole(`‚úÖ Producto eliminado en ${duration}ms`);
                
                // Recargar lista de productos
                await loadProductsForTesting();
                
            } catch (error) {
                logToConsole(`‚ùå Error eliminando producto: ${error.message}`);
            }
        }

        // Funciones auxiliares
        function updateStatus(message, type) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }

        function logToConsole(message) {
            const consoleElement = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            consoleElement.textContent += `[${timestamp}] ${message}\n`;
            consoleElement.scrollTop = consoleElement.scrollHeight;
            console.log(message);
        }

        function updateTimingInfo(method, duration, products, error = null, comparison = null) {
            const timingElement = document.getElementById('timingInfo');
            
            if (comparison) {
                timingElement.innerHTML = `
                    <strong>üìä Comparaci√≥n de M√©todos:</strong><br>
                    Normal: ${comparison.normal.duration}ms, ${comparison.normal.products} productos ${comparison.normal.error ? '(ERROR)' : '(OK)'}<br>
                    R√°pido: ${comparison.fast.duration}ms, ${comparison.fast.products} productos ${comparison.fast.error ? '(ERROR)' : '(OK)'}
                `;
            } else {
                timingElement.innerHTML = `
                    <strong>‚è±Ô∏è √öltimo Test (${method}):</strong><br>
                    Duraci√≥n: ${duration}ms<br>
                    Productos: ${products}<br>
                    ${error ? `Error: ${error}` : 'Estado: OK'}
                `;
            }
        }

        function clearConsole() {
            document.getElementById('console').textContent = '';
            document.getElementById('timingInfo').textContent = 'Tiempos de ejecuci√≥n aparecer√°n aqu√≠...';
            logToConsole('üßπ Console limpiado');
        }
    </script>
</body>
</html>
