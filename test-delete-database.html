<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Eliminaci√≥n Base de Datos</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container { 
            background: white; 
            padding: 30px; 
            border-radius: 15px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .test-section { 
            background: #f8f9fa; 
            padding: 20px; 
            margin: 20px 0; 
            border-radius: 10px; 
            border-left: 4px solid #007bff;
        }
        .btn { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 12px 20px; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 5px;
            font-size: 14px;
        }
        .btn:hover { background: #0056b3; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .log { 
            background: #1a1a1a; 
            color: #00ff00; 
            padding: 15px; 
            border-radius: 5px; 
            font-family: 'Courier New', monospace; 
            font-size: 12px; 
            max-height: 400px; 
            overflow-y: auto; 
            margin-top: 10px;
        }
        .products-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .product-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            position: relative;
        }
        .product-card.test-product {
            border-left: 4px solid #ff6b6b;
            background: #fff5f5;
        }
        .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 12px;
        }
        .status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            margin-left: 10px;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagn√≥stico de Eliminaci√≥n en Base de Datos</h1>
        <p>Esta herramienta nos ayudar√° a identificar por qu√© los productos no se eliminan realmente de la base de datos.</p>

        <div class="test-section">
            <h3>üß™ 1. Crear Producto de Prueba</h3>
            <p>Primero creamos un producto espec√≠fico para probar la eliminaci√≥n:</p>
            <button class="btn" onclick="crearProductoPrueba()">Crear Producto de Prueba</button>
            <span id="createStatus"></span>
        </div>

        <div class="test-section">
            <h3>üìã 2. Listar Productos Actuales</h3>
            <p>Ver todos los productos en la base de datos:</p>
            <button class="btn" onclick="listarProductos()">Listar Productos</button>
            <button class="btn btn-success" onclick="listarProductos(true)">Refrescar desde DB</button>
            <span id="listStatus"></span>
            <div id="productsList" class="products-list"></div>
        </div>

        <div class="test-section">
            <h3>üóëÔ∏è 3. Probar Eliminaci√≥n Directa</h3>
            <p>Eliminar usando comandos directos de Supabase:</p>
            <input type="number" id="deleteId" placeholder="ID del producto a eliminar" style="padding: 8px; margin-right: 10px;">
            <button class="btn btn-danger" onclick="eliminarDirecto()">Eliminar Directo</button>
            <button class="btn btn-danger" onclick="eliminarConSQL()">Eliminar con SQL Raw</button>
            <span id="deleteStatus"></span>
        </div>

        <div class="test-section">
            <h3>üîç 4. Verificar Pol√≠ticas RLS</h3>
            <p>Revisar pol√≠ticas de seguridad de Row Level Security:</p>
            <button class="btn" onclick="verificarRLS()">Verificar RLS</button>
            <button class="btn" onclick="verificarPermisos()">Verificar Permisos</button>
            <span id="rlsStatus"></span>
        </div>

        <div class="test-section">
            <h3>üìä 5. Informaci√≥n de la Tabla</h3>
            <p>Obtener informaci√≥n detallada sobre la estructura de la tabla:</p>
            <button class="btn" onclick="obtenerInfoTabla()">Info de Tabla</button>
            <span id="tableStatus"></span>
        </div>

        <div id="logContainer">
            <h3>üìù Log de Actividad</h3>
            <div id="testLog" class="log"></div>
        </div>
    </div>

    <!-- Incluir Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    
    <script>
        let testProductId = null;

        function log(message, type = 'info') {
            const logElement = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            
            logElement.innerHTML += `[${timestamp}] ${icon} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`${icon} ${message}`);
        }

        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<span class="status ${type}">${message}</span>`;
        }

        async function crearProductoPrueba() {
            try {
                log('üß™ Creando producto de prueba...');
                updateStatus('createStatus', 'Creando...', 'warning');

                const testProduct = {
                    nombre: `Test Delete ${Date.now()}`,
                    marca: 'Test Brand',
                    precio: 50000,
                    categoria: 'para-ellos',
                    descripcion: 'Producto creado espec√≠ficamente para probar eliminaci√≥n',
                    activo: true,
                    estado: 'disponible'
                };

                const result = await ProductosService.crearProducto(testProduct);
                testProductId = result.id;
                
                log(`‚úÖ Producto de prueba creado con ID: ${testProductId}`);
                updateStatus('createStatus', `Creado ID: ${testProductId}`, 'success');
                
                // Listar productos autom√°ticamente
                await listarProductos();
                
            } catch (error) {
                log(`‚ùå Error creando producto de prueba: ${error.message}`, 'error');
                updateStatus('createStatus', 'Error al crear', 'error');
            }
        }

        async function listarProductos(forceRefresh = false) {
            try {
                log(`üìã ${forceRefresh ? 'Refrescando' : 'Listando'} productos...`);
                updateStatus('listStatus', 'Cargando...', 'warning');

                let productos;
                if (forceRefresh) {
                    // Consulta directa a Supabase sin cach√©
                    const { data, error } = await supabaseClient
                        .from('productos')
                        .select('*')
                        .order('id', { ascending: false });
                    
                    if (error) throw error;
                    productos = data;
                    log(`üîÑ Productos obtenidos directamente de DB: ${productos.length}`);
                } else {
                    productos = await ProductosService.obtenerProductos();
                    log(`üì¶ Productos obtenidos del servicio: ${productos.length}`);
                }

                const container = document.getElementById('productsList');
                
                if (productos.length === 0) {
                    container.innerHTML = '<p>No hay productos en la base de datos</p>';
                    updateStatus('listStatus', 'Sin productos', 'warning');
                    return;
                }

                const productsHTML = productos.map(product => `
                    <div class="product-card ${product.nombre.includes('Test Delete') ? 'test-product' : ''}">
                        <button class="delete-btn" onclick="eliminarProducto(${product.id})" title="Eliminar">üóëÔ∏è</button>
                        <h4>${product.nombre}</h4>
                        <p><strong>ID:</strong> ${product.id}</p>
                        <p><strong>Marca:</strong> ${product.marca || 'N/A'}</p>
                        <p><strong>Precio:</strong> $${product.precio}</p>
                        <p><strong>Categor√≠a:</strong> ${product.categoria}</p>
                        <p><strong>Estado:</strong> ${product.estado || 'disponible'}</p>
                        <p><strong>Activo:</strong> ${product.activo !== false ? 'S√≠' : 'No'}</p>
                        ${product.created_at ? `<p><strong>Creado:</strong> ${new Date(product.created_at).toLocaleString()}</p>` : ''}
                    </div>
                `).join('');

                container.innerHTML = productsHTML;
                updateStatus('listStatus', `${productos.length} productos`, 'success');
                log(`‚úÖ Lista actualizada con ${productos.length} productos`);

            } catch (error) {
                log(`‚ùå Error listando productos: ${error.message}`, 'error');
                updateStatus('listStatus', 'Error al listar', 'error');
            }
        }

        async function eliminarProducto(productId) {
            if (!confirm(`¬øEliminar producto ID ${productId}?`)) return;
            
            try {
                log(`üóëÔ∏è Eliminando producto ID: ${productId}`);
                
                const result = await ProductosService.deleteProduct(productId);
                log(`‚úÖ Resultado eliminaci√≥n: ${JSON.stringify(result)}`);
                
                // Esperar un momento y verificar si realmente se elimin√≥
                setTimeout(async () => {
                    await verificarEliminacion(productId);
                    await listarProductos(true);
                }, 1000);
                
            } catch (error) {
                log(`‚ùå Error eliminando producto: ${error.message}`, 'error');
            }
        }

        async function eliminarDirecto() {
            const productId = document.getElementById('deleteId').value;
            if (!productId) {
                alert('Por favor ingresa un ID de producto');
                return;
            }

            try {
                log(`üóëÔ∏è Eliminaci√≥n DIRECTA del producto ID: ${productId}`);
                updateStatus('deleteStatus', 'Eliminando...', 'warning');

                // Primero verificar que existe
                const { data: existingProduct, error: selectError } = await supabaseClient
                    .from('productos')
                    .select('*')
                    .eq('id', productId)
                    .single();

                if (selectError) {
                    log(`‚ùå Error buscando producto: ${selectError.message}`, 'error');
                    updateStatus('deleteStatus', 'Producto no encontrado', 'error');
                    return;
                }

                log(`üìã Producto encontrado: ${existingProduct.nombre}`);

                // Intentar eliminaci√≥n directa
                const { data, error } = await supabaseClient
                    .from('productos')
                    .delete()
                    .eq('id', productId)
                    .select();

                if (error) {
                    log(`‚ùå Error en DELETE: ${error.message}`, 'error');
                    log(`‚ùå C√≥digo de error: ${error.code}`);
                    log(`‚ùå Detalles: ${JSON.stringify(error.details)}`);
                    updateStatus('deleteStatus', `Error: ${error.message}`, 'error');
                    return;
                }

                log(`‚úÖ DELETE ejecutado. Datos retornados: ${JSON.stringify(data)}`);

                // Verificar si realmente se elimin√≥
                setTimeout(async () => {
                    await verificarEliminacion(productId);
                    await listarProductos(true);
                    updateStatus('deleteStatus', 'Eliminaci√≥n completada', 'success');
                }, 1000);

            } catch (error) {
                log(`‚ùå Error en eliminaci√≥n directa: ${error.message}`, 'error');
                updateStatus('deleteStatus', 'Error eliminando', 'error');
            }
        }

        async function eliminarConSQL() {
            const productId = document.getElementById('deleteId').value;
            if (!productId) {
                alert('Por favor ingresa un ID de producto');
                return;
            }

            try {
                log(`üóëÔ∏è Eliminaci√≥n con SQL RAW del producto ID: ${productId}`);
                
                // Usar RPC (funci√≥n SQL) para eliminar
                const { data, error } = await supabaseClient
                    .rpc('delete_producto', { producto_id: productId });

                if (error) {
                    log(`‚ùå Error en RPC delete: ${error.message}`, 'error');
                    
                    // Si no existe la funci√≥n RPC, intentar con SQL directo
                    log('üîÑ Intentando con SQL directo...');
                    
                    const { data: sqlData, error: sqlError } = await supabaseClient
                        .from('productos')
                        .delete()
                        .eq('id', productId);

                    if (sqlError) {
                        log(`‚ùå Error en SQL directo: ${sqlError.message}`, 'error');
                        return;
                    }
                    
                    log(`‚úÖ SQL directo ejecutado`);
                } else {
                    log(`‚úÖ RPC delete ejecutado: ${JSON.stringify(data)}`);
                }

                // Verificar eliminaci√≥n
                setTimeout(async () => {
                    await verificarEliminacion(productId);
                    await listarProductos(true);
                }, 1000);

            } catch (error) {
                log(`‚ùå Error en eliminaci√≥n SQL: ${error.message}`, 'error');
            }
        }

        async function verificarEliminacion(productId) {
            try {
                log(`üîç Verificando si el producto ID ${productId} fue eliminado...`);
                
                const { data, error } = await supabaseClient
                    .from('productos')
                    .select('*')
                    .eq('id', productId);

                if (error) {
                    log(`‚ùå Error verificando: ${error.message}`, 'error');
                    return;
                }

                if (data && data.length === 0) {
                    log(`‚úÖ Confirmado: Producto ID ${productId} eliminado correctamente`, 'success');
                } else {
                    log(`‚ùå PROBLEMA: Producto ID ${productId} A√öN EXISTE en la base de datos`, 'error');
                    log(`üìã Datos del producto: ${JSON.stringify(data[0])}`);
                }

            } catch (error) {
                log(`‚ùå Error verificando eliminaci√≥n: ${error.message}`, 'error');
            }
        }

        async function verificarRLS() {
            try {
                log('üîç Verificando pol√≠ticas RLS...');
                updateStatus('rlsStatus', 'Verificando...', 'warning');

                // Intentar obtener informaci√≥n sobre RLS
                const { data, error } = await supabaseClient
                    .from('productos')
                    .select('*')
                    .limit(1);

                if (error) {
                    log(`‚ùå Error accediendo a productos: ${error.message}`, 'error');
                    if (error.message.includes('RLS') || error.message.includes('policy')) {
                        log('‚ö†Ô∏è Posible problema con Row Level Security (RLS)', 'warning');
                        updateStatus('rlsStatus', 'Problema RLS detectado', 'error');
                    }
                    return;
                }

                log('‚úÖ Acceso a tabla productos funcionando correctamente');
                
                // Intentar insertar y eliminar un registro de prueba para verificar permisos
                try {
                    const testRecord = {
                        nombre: 'Test RLS Temp',
                        marca: 'Test',
                        precio: 1,
                        categoria: 'test'
                    };

                    const { data: insertData, error: insertError } = await supabaseClient
                        .from('productos')
                        .insert([testRecord])
                        .select();

                    if (insertError) {
                        log(`‚ùå Error INSERT (permisos): ${insertError.message}`, 'error');
                        updateStatus('rlsStatus', 'Sin permisos INSERT', 'error');
                        return;
                    }

                    const tempId = insertData[0].id;
                    log(`‚úÖ INSERT funcionando - Temp ID: ${tempId}`);

                    // Intentar DELETE
                    const { error: deleteError } = await supabaseClient
                        .from('productos')
                        .delete()
                        .eq('id', tempId);

                    if (deleteError) {
                        log(`‚ùå Error DELETE (permisos): ${deleteError.message}`, 'error');
                        updateStatus('rlsStatus', 'Sin permisos DELETE', 'error');
                    } else {
                        log(`‚úÖ DELETE funcionando - Temp record eliminado`);
                        updateStatus('rlsStatus', 'Permisos OK', 'success');
                    }

                } catch (testError) {
                    log(`‚ùå Error en test de permisos: ${testError.message}`, 'error');
                }

            } catch (error) {
                log(`‚ùå Error verificando RLS: ${error.message}`, 'error');
                updateStatus('rlsStatus', 'Error verificando', 'error');
            }
        }

        async function verificarPermisos() {
            try {
                log('üîç Verificando permisos espec√≠ficos...');
                
                // Obtener informaci√≥n del usuario actual
                const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
                
                if (userError) {
                    log(`‚ùå Error obteniendo usuario: ${userError.message}`, 'error');
                    log('‚ö†Ô∏è Posible problema: Usuario no autenticado', 'warning');
                    return;
                }

                if (!user) {
                    log('‚ö†Ô∏è No hay usuario autenticado - usando acceso an√≥nimo', 'warning');
                } else {
                    log(`‚úÖ Usuario autenticado: ${user.email || user.id}`);
                }

                // Verificar configuraci√≥n de la tabla
                log('üîç Verificando configuraci√≥n de tabla...');
                
                // Esto puede requerir permisos especiales
                try {
                    const { data, error } = await supabaseClient
                        .from('productos')
                        .select('count', { count: 'exact' });

                    if (error) {
                        log(`‚ùå Error contando registros: ${error.message}`, 'error');
                    } else {
                        log(`‚úÖ Acceso a datos funcionando - Total registros: ${data.length > 0 ? data[0].count : 'desconocido'}`);
                    }
                } catch (countError) {
                    log(`‚ùå Error en count: ${countError.message}`, 'error');
                }

            } catch (error) {
                log(`‚ùå Error verificando permisos: ${error.message}`, 'error');
            }
        }

        async function obtenerInfoTabla() {
            try {
                log('üìä Obteniendo informaci√≥n de la tabla...');
                updateStatus('tableStatus', 'Obteniendo info...', 'warning');

                // Informaci√≥n b√°sica de la tabla
                const { data, error } = await supabaseClient
                    .from('productos')
                    .select('*')
                    .limit(1);

                if (error) {
                    log(`‚ùå Error accediendo a tabla: ${error.message}`, 'error');
                    updateStatus('tableStatus', 'Error acceso tabla', 'error');
                    return;
                }

                if (data && data.length > 0) {
                    const sampleRecord = data[0];
                    const columns = Object.keys(sampleRecord);
                    
                    log(`‚úÖ Tabla 'productos' accesible`);
                    log(`üìã Columnas detectadas: ${columns.join(', ')}`);
                    log(`üìã Registro ejemplo: ${JSON.stringify(sampleRecord, null, 2)}`);
                    
                    updateStatus('tableStatus', `${columns.length} columnas detectadas`, 'success');
                } else {
                    log('‚ö†Ô∏è Tabla vac√≠a o sin acceso a registros', 'warning');
                    updateStatus('tableStatus', 'Tabla vac√≠a', 'warning');
                }

            } catch (error) {
                log(`‚ùå Error obteniendo info de tabla: ${error.message}`, 'error');
                updateStatus('tableStatus', 'Error obteniendo info', 'error');
            }
        }

        // Inicializar al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            log('üöÄ Herramienta de diagn√≥stico iniciada');
            log('üìã Usa los botones para probar diferentes aspectos de la eliminaci√≥n');
        });
    </script>
</body>
</html>
