<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico de Im√°genes</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px;
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            min-height: 100vh;
        }
        .container { 
            background: white; 
            padding: 30px; 
            border-radius: 15px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .step { 
            background: #f8f9fa; 
            padding: 20px; 
            margin: 20px 0; 
            border-radius: 10px; 
            border-left: 4px solid #74b9ff;
        }
        .btn { 
            background: #74b9ff; 
            color: white; 
            border: none; 
            padding: 12px 20px; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 5px;
            font-size: 14px;
        }
        .btn:hover { background: #0984e3; }
        .btn-success { background: #00b894; }
        .btn-success:hover { background: #00a085; }
        .btn-warning { background: #fdcb6e; color: #2d3436; }
        .btn-warning:hover { background: #e17055; color: white; }
        .log { 
            background: #1a1a1a; 
            color: #00ff00; 
            padding: 15px; 
            border-radius: 5px; 
            font-family: 'Courier New', monospace; 
            font-size: 12px; 
            max-height: 400px; 
            overflow-y: auto; 
            margin-top: 10px;
        }
        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .image-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .image-preview {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .image-broken {
            background: #f8d7da;
            border: 2px dashed #dc3545;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #721c24;
        }
        .status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            margin-left: 10px;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üñºÔ∏è Diagn√≥stico y Reparaci√≥n de Im√°genes</h1>
        <p>Esta herramienta diagnostica problemas con las rutas de im√°genes de los productos.</p>

        <div class="step">
            <h3>üìä 1. Analizar Productos e Im√°genes</h3>
            <p>Cargar todos los productos y verificar el estado de sus im√°genes:</p>
            <button class="btn" onclick="analizarImagenes()">Analizar Im√°genes</button>
            <span id="analyzeStatus"></span>
        </div>

        <div class="step">
            <h3>üîß 2. Corregir Rutas Autom√°ticamente</h3>
            <p>Intentar corregir autom√°ticamente las rutas bas√°ndose en los archivos disponibles:</p>
            <button class="btn btn-warning" onclick="corregirRutas()">Corregir Rutas</button>
            <span id="fixStatus"></span>
        </div>

        <div class="step">
            <h3>üìÅ 3. Mapear Archivos Disponibles</h3>
            <p>Ver qu√© archivos de imagen est√°n disponibles:</p>
            <button class="btn btn-success" onclick="mapearArchivos()">Mapear Archivos</button>
            <span id="mapStatus"></span>
        </div>

        <div id="imageResults"></div>

        <div id="logContainer">
            <h3>üìù Log de Diagn√≥stico</h3>
            <div id="imageLog" class="log"></div>
        </div>
    </div>

    <!-- Incluir Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    
    <script>
        let productos = [];
        let archivosDisponibles = [];

        function log(message, type = 'info') {
            const logElement = document.getElementById('imageLog');
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            
            logElement.innerHTML += `[${timestamp}] ${icon} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`${icon} ${message}`);
        }

        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<span class="status ${type}">${message}</span>`;
        }

        async function analizarImagenes() {
            try {
                log('üîç Iniciando an√°lisis de im√°genes...');
                updateStatus('analyzeStatus', 'Analizando...', 'warning');

                // Cargar productos
                if (typeof ProductosService !== 'undefined') {
                    productos = await ProductosService.obtenerProductos();
                    log(`üì¶ ${productos.length} productos cargados`);
                } else {
                    log('‚ùå ProductosService no disponible', 'error');
                    updateStatus('analyzeStatus', 'Error: Service no disponible', 'error');
                    return;
                }

                // Filtrar productos para ellos
                const productosParaEllos = productos.filter(p => p.categoria === 'para-ellos');
                log(`üëî ${productosParaEllos.length} productos para ellos encontrados`);

                // Analizar cada imagen
                const imageAnalysis = [];
                for (const product of productosParaEllos) {
                    const analysis = await analyzeProductImage(product);
                    imageAnalysis.push(analysis);
                }

                // Mostrar resultados
                displayImageAnalysis(imageAnalysis);
                
                const brokenImages = imageAnalysis.filter(a => !a.imageWorks);
                log(`‚úÖ An√°lisis completado: ${imageAnalysis.length - brokenImages.length} OK, ${brokenImages.length} problemas`);
                updateStatus('analyzeStatus', `${brokenImages.length} problemas encontrados`, brokenImages.length > 0 ? 'error' : 'success');

            } catch (error) {
                log(`‚ùå Error en an√°lisis: ${error.message}`, 'error');
                updateStatus('analyzeStatus', 'Error en an√°lisis', 'error');
            }
        }

        async function analyzeProductImage(product) {
            const analysis = {
                id: product.id,
                nombre: product.nombre,
                marca: product.marca,
                imagenUrl: product.imagen_url || product.imagen,
                imageWorks: false,
                suggestedPath: null,
                error: null
            };

            if (!analysis.imagenUrl) {
                analysis.error = 'Sin URL de imagen configurada';
                return analysis;
            }

            try {
                // Probar si la imagen carga
                const imageExists = await checkImageExists(analysis.imagenUrl);
                analysis.imageWorks = imageExists;
                
                if (!imageExists) {
                    analysis.error = 'Imagen no accesible';
                    // Intentar sugerir una ruta alternativa
                    analysis.suggestedPath = suggestImagePath(product);
                }

            } catch (error) {
                analysis.error = error.message;
            }

            return analysis;
        }

        function checkImageExists(url) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => resolve(true);
                img.onerror = () => resolve(false);
                
                // Timeout para evitar esperas largas
                setTimeout(() => resolve(false), 5000);
                
                img.src = url;
            });
        }

        function suggestImagePath(product) {
            const nombre = product.nombre || '';
            const marca = product.marca || '';
            
            // Mapear nombres a archivos conocidos
            const nameToFileMap = {
                'one million paco rabanne': 'ONE_MILLON_PACO_RABANE.png',
                '212 men carolina herrera': '212_CAROLINA_HERRERA.png',
                'givenchy blue label': 'GIVENCHY_BLUE_LABEL.png',
                'montblanc legend night': 'MONTBLACK_LEGEND_NIGH.png',
                'versace eros blue': 'VERSACE_EROS_BLUE.png'
            };

            const searchKey = `${nombre} ${marca}`.toLowerCase().trim();
            
            for (const [key, filename] of Object.entries(nameToFileMap)) {
                if (searchKey.includes(key) || key.includes(searchKey.substring(0, 10))) {
                    return `LOCIONES_PARA _ELLOS/${filename}`;
                }
            }

            return null;
        }

        function displayImageAnalysis(analysis) {
            const container = document.getElementById('imageResults');
            
            const html = `
                <div class="step">
                    <h3>üìä Resultados del An√°lisis</h3>
                    <div class="images-grid">
                        ${analysis.map(item => `
                            <div class="image-card">
                                <div class="image-preview ${!item.imageWorks ? 'image-broken' : ''}" 
                                     style="background-image: url('${item.imageWorks ? item.imagenUrl : ''}');">
                                    ${!item.imageWorks ? '‚ùå Imagen no disponible' : ''}
                                    ${item.imageWorks ? `<img src="${item.imagenUrl}" class="image-preview" alt="${item.nombre}">` : ''}
                                </div>
                                <h4>${item.nombre}</h4>
                                <p><strong>Marca:</strong> ${item.marca || 'N/A'}</p>
                                <p><strong>URL actual:</strong> <code>${item.imagenUrl || 'N/A'}</code></p>
                                <p><strong>Estado:</strong> 
                                    <span class="status ${item.imageWorks ? 'success' : 'error'}">
                                        ${item.imageWorks ? '‚úÖ OK' : '‚ùå Error'}
                                    </span>
                                </p>
                                ${item.error ? `<p><strong>Error:</strong> ${item.error}</p>` : ''}
                                ${item.suggestedPath ? `
                                    <p><strong>Ruta sugerida:</strong> <code>${item.suggestedPath}</code></p>
                                    <button class="btn btn-sm" onclick="aplicarRutaSugerida(${item.id}, '${item.suggestedPath}')">
                                        Aplicar Sugerencia
                                    </button>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        async function aplicarRutaSugerida(productId, newPath) {
            try {
                log(`üîÑ Aplicando nueva ruta para producto ID ${productId}: ${newPath}`);
                
                const result = await ProductosService.updateProduct(productId, {
                    imagen_url: newPath
                });
                
                if (result) {
                    log(`‚úÖ Ruta actualizada exitosamente para producto ID ${productId}`, 'success');
                    // Reanalizar despu√©s de actualizar
                    setTimeout(() => analizarImagenes(), 1000);
                } else {
                    log(`‚ùå Error actualizando producto ID ${productId}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå Error aplicando ruta sugerida: ${error.message}`, 'error');
            }
        }

        async function corregirRutas() {
            try {
                log('üîß Iniciando correcci√≥n autom√°tica de rutas...');
                updateStatus('fixStatus', 'Corrigiendo...', 'warning');

                if (productos.length === 0) {
                    log('‚ö†Ô∏è Primero ejecuta el an√°lisis de im√°genes', 'warning');
                    updateStatus('fixStatus', 'Ejecuta an√°lisis primero', 'warning');
                    return;
                }

                const productosParaEllos = productos.filter(p => p.categoria === 'para-ellos');
                let corrected = 0;

                for (const product of productosParaEllos) {
                    const currentImage = product.imagen_url || product.imagen;
                    
                    if (!currentImage || !await checkImageExists(currentImage)) {
                        const suggestedPath = suggestImagePath(product);
                        
                        if (suggestedPath && await checkImageExists(suggestedPath)) {
                            try {
                                await ProductosService.updateProduct(product.id, {
                                    imagen_url: suggestedPath
                                });
                                log(`‚úÖ Corregida ruta para: ${product.nombre} -> ${suggestedPath}`, 'success');
                                corrected++;
                            } catch (error) {
                                log(`‚ùå Error corrigiendo ${product.nombre}: ${error.message}`, 'error');
                            }
                        }
                    }
                }

                log(`‚úÖ Correcci√≥n completada: ${corrected} rutas corregidas`);
                updateStatus('fixStatus', `${corrected} rutas corregidas`, 'success');
                
                // Recargar an√°lisis
                setTimeout(() => analizarImagenes(), 1000);

            } catch (error) {
                log(`‚ùå Error en correcci√≥n autom√°tica: ${error.message}`, 'error');
                updateStatus('fixStatus', 'Error en correcci√≥n', 'error');
            }
        }

        async function mapearArchivos() {
            try {
                log('üìÅ Mapeando archivos disponibles...');
                updateStatus('mapStatus', 'Mapeando...', 'warning');

                // Lista de archivos conocidos
                const archivosConocidos = [
                    'ONE_MILLON_PACO_RABANE.png',
                    '212_CAROLINA_HERRERA.png', 
                    'GIVENCHY_BLUE_LABEL.png',
                    'MONTBLACK_LEGEND_NIGH.png',
                    'VERSACE_EROS_BLUE.png'
                ];

                log('üìÇ Archivos en LOCIONES_PARA_ELLOS:');
                
                for (const archivo of archivosConocidos) {
                    const rutaCompleta = `LOCIONES_PARA _ELLOS/${archivo}`;
                    const existe = await checkImageExists(rutaCompleta);
                    log(`   ${existe ? '‚úÖ' : '‚ùå'} ${archivo} -> ${rutaCompleta}`);
                }

                // Tambi√©n verificar rutas alternativas
                log('üîç Verificando rutas alternativas:');
                const rutasAlternativas = [
                    '../LOCIONES_PARA _ELLOS/',
                    './LOCIONES_PARA _ELLOS/',
                    '/LOCIONES_PARA _ELLOS/',
                ];

                for (const rutaBase of rutasAlternativas) {
                    log(`üìÇ Probando ruta base: ${rutaBase}`);
                    for (const archivo of archivosConocidos.slice(0, 2)) { // Solo probar 2 para no saturar
                        const rutaCompleta = `${rutaBase}${archivo}`;
                        const existe = await checkImageExists(rutaCompleta);
                        log(`   ${existe ? '‚úÖ' : '‚ùå'} ${rutaCompleta}`);
                        if (existe) break; // Si encontramos una que funciona, no necesitamos probar m√°s
                    }
                }

                updateStatus('mapStatus', 'Mapeo completado', 'success');

            } catch (error) {
                log(`‚ùå Error mapeando archivos: ${error.message}`, 'error');
                updateStatus('mapStatus', 'Error en mapeo', 'error');
            }
        }

        // Inicializar al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            log('üöÄ Herramienta de diagn√≥stico de im√°genes iniciada');
            log('üìã Usa los botones para diagnosticar y corregir problemas de im√°genes');
        });
    </script>
</body>
</html>
