<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificar Imagen en Base de Datos</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, button {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background: #007bff;
            color: white;
            cursor: pointer;
            margin: 5px 0;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .result.success { background: #d4edda; border: 1px solid #c3e6cb; }
        .result.error { background: #f8d7da; border: 1px solid #f5c6cb; }
        .result.info { background: #d1ecf1; border: 1px solid #bee5eb; }
        .image-display {
            max-width: 200px;
            max-height: 200px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Verificar Imagen en Base de Datos</h1>
        <p>Esta herramienta verifica si la imagen del producto ID 33 (o cualquier otro) se guard√≥ correctamente en la base de datos.</p>

        <div class="form-group">
            <label for="productId">ID del Producto a Verificar:</label>
            <input type="number" id="productId" value="33" placeholder="Ingresa el ID del producto">
        </div>
        
        <button onclick="verificarProducto()">üîç Verificar Producto</button>
        <button onclick="listarTodosLosProductos()">üìã Listar Todos los Productos</button>
        <button onclick="verificarUltimoProducto()">üÜï Verificar √öltimo Producto Creado</button>

        <div id="result"></div>
        <div id="imageDisplay"></div>
    </div>

    <!-- Scripts necesarios -->
    <script src="js/supabase-config.js"></script>
    
    <script>
        function mostrarResultado(mensaje, tipo = 'info') {
            const resultDiv = document.getElementById('result');
            resultDiv.className = `result ${tipo}`;
            resultDiv.textContent = mensaje;
        }
        
        function mostrarImagen(imageUrl) {
            const imageDisplay = document.getElementById('imageDisplay');
            
            if (imageUrl && imageUrl.trim()) {
                const img = document.createElement('img');
                img.className = 'image-display';
                img.src = imageUrl;
                img.alt = 'Imagen del producto';
                img.onerror = function() {
                    imageDisplay.innerHTML = '<p style="color: red;">‚ùå Error cargando imagen</p>';
                };
                imageDisplay.innerHTML = '';
                imageDisplay.appendChild(img);
            } else {
                imageDisplay.innerHTML = '<p style="color: orange;">‚ö†Ô∏è No hay imagen para mostrar</p>';
            }
        }
        
        async function verificarProducto() {
            const productId = document.getElementById('productId').value;
            
            if (!productId) {
                mostrarResultado('Por favor ingresa un ID de producto v√°lido', 'error');
                return;
            }
            
            try {
                mostrarResultado('üîÑ Consultando producto...', 'info');
                
                if (typeof ProductosService === 'undefined') {
                    throw new Error('ProductosService no est√° disponible');
                }
                
                const producto = await ProductosService.obtenerProductoPorId(parseInt(productId));
                
                if (!producto) {
                    mostrarResultado(`‚ùå No se encontr√≥ el producto con ID ${productId}`, 'error');
                    return;
                }
                
                let reporte = `‚úÖ Producto encontrado: ${producto.nombre}\n\n`;
                reporte += `üìä DATOS DEL PRODUCTO:\n`;
                reporte += `   - ID: ${producto.id}\n`;
                reporte += `   - Nombre: ${producto.nombre}\n`;
                reporte += `   - Marca: ${producto.marca}\n`;
                reporte += `   - Precio: $${producto.precio}\n`;
                reporte += `   - Categor√≠a: ${producto.categoria}\n`;
                reporte += `   - Activo: ${producto.activo}\n\n`;
                
                // Verificar imagen
                reporte += `üñºÔ∏è AN√ÅLISIS DE IMAGEN:\n`;
                
                if (producto.imagen_url) {
                    reporte += `   - Campo imagen_url: PRESENTE ‚úÖ\n`;
                    reporte += `   - Tipo de dato: ${typeof producto.imagen_url}\n`;
                    reporte += `   - Longitud: ${producto.imagen_url.length} caracteres\n`;
                    
                    if (producto.imagen_url.startsWith('data:image/')) {
                        reporte += `   - Formato: Base64 (imagen desde archivo) ‚úÖ\n`;
                        const sizeKB = (producto.imagen_url.length / 1024).toFixed(1);
                        reporte += `   - Tama√±o: ${sizeKB}KB\n`;
                        
                        // Detectar tipo de imagen
                        const mimeMatch = producto.imagen_url.match(/^data:image\/([^;]+);base64,/);
                        if (mimeMatch) {
                            reporte += `   - Tipo de imagen: ${mimeMatch[1].toUpperCase()}\n`;
                        }
                        
                        mostrarImagen(producto.imagen_url);
                        
                    } else if (producto.imagen_url.startsWith('http://') || producto.imagen_url.startsWith('https://')) {
                        reporte += `   - Formato: URL externa ‚úÖ\n`;
                        reporte += `   - URL: ${producto.imagen_url}\n`;
                        mostrarImagen(producto.imagen_url);
                        
                    } else if (producto.imagen_url.startsWith('./') || producto.imagen_url.startsWith('../')) {
                        reporte += `   - Formato: Ruta relativa ‚úÖ\n`;
                        reporte += `   - Ruta: ${producto.imagen_url}\n`;
                        mostrarImagen(producto.imagen_url);
                        
                    } else {
                        reporte += `   - Formato: DESCONOCIDO ‚ö†Ô∏è\n`;
                        reporte += `   - Contenido: ${producto.imagen_url.substring(0, 100)}...\n`;
                    }
                } else {
                    reporte += `   - Campo imagen_url: AUSENTE ‚ùå\n`;
                    document.getElementById('imageDisplay').innerHTML = '';
                }
                
                // Verificar campo alternativo 'imagen'
                if (producto.imagen) {
                    reporte += `   - Campo imagen (alternativo): PRESENTE ‚úÖ\n`;
                    reporte += `   - Contenido: ${producto.imagen.substring(0, 50)}...\n`;
                } else {
                    reporte += `   - Campo imagen (alternativo): AUSENTE ‚ùå\n`;
                }
                
                // Conclusi√≥n
                reporte += `\nüéØ CONCLUSI√ìN:\n`;
                if (producto.imagen_url && producto.imagen_url.startsWith('data:image/')) {
                    reporte += `   ‚úÖ La imagen se guard√≥ correctamente como Base64\n`;
                    reporte += `   ‚úÖ Deber√≠a mostrarse en el panel admin y cat√°logo`;
                } else if (producto.imagen_url) {
                    reporte += `   ‚úÖ La imagen se guard√≥ como URL/ruta\n`;
                    reporte += `   ‚ö†Ô∏è Verificar que la ruta sea accesible`;
                } else {
                    reporte += `   ‚ùå NO HAY IMAGEN GUARDADA\n`;
                    reporte += `   üí° El problema est√° en el proceso de env√≠o del formulario`;
                }
                
                mostrarResultado(reporte, 'success');
                
            } catch (error) {
                mostrarResultado(`‚ùå Error verificando producto: ${error.message}`, 'error');
                console.error('Error completo:', error);
            }
        }
        
        async function listarTodosLosProductos() {
            try {
                mostrarResultado('üîÑ Cargando todos los productos...', 'info');
                
                if (typeof ProductosService === 'undefined') {
                    throw new Error('ProductosService no est√° disponible');
                }
                
                const productos = await ProductosService.obtenerProductos();
                
                let reporte = `üìã LISTA DE PRODUCTOS (${productos.length} total):\n\n`;
                
                productos.forEach((producto, index) => {
                    reporte += `${index + 1}. ID: ${producto.id} - ${producto.nombre}\n`;
                    reporte += `   Marca: ${producto.marca}\n`;
                    
                    if (producto.imagen_url) {
                        if (producto.imagen_url.startsWith('data:image/')) {
                            const sizeKB = (producto.imagen_url.length / 1024).toFixed(1);
                            reporte += `   Imagen: Base64 (${sizeKB}KB) ‚úÖ\n`;
                        } else {
                            reporte += `   Imagen: URL/Ruta ‚úÖ\n`;
                        }
                    } else {
                        reporte += `   Imagen: Sin imagen ‚ùå\n`;
                    }
                    reporte += `\n`;
                });
                
                // Resumen
                const conImagen = productos.filter(p => p.imagen_url && p.imagen_url.trim()).length;
                const conImagenBase64 = productos.filter(p => p.imagen_url && p.imagen_url.startsWith('data:image/')).length;
                
                reporte += `üìä RESUMEN:\n`;
                reporte += `   - Total productos: ${productos.length}\n`;
                reporte += `   - Con imagen: ${conImagen}\n`;
                reporte += `   - Con imagen Base64: ${conImagenBase64}\n`;
                reporte += `   - Sin imagen: ${productos.length - conImagen}`;
                
                mostrarResultado(reporte, 'info');
                
            } catch (error) {
                mostrarResultado(`‚ùå Error listando productos: ${error.message}`, 'error');
            }
        }
        
        async function verificarUltimoProducto() {
            try {
                mostrarResultado('üîÑ Buscando el √∫ltimo producto creado...', 'info');
                
                if (typeof ProductosService === 'undefined') {
                    throw new Error('ProductosService no est√° disponible');
                }
                
                const productos = await ProductosService.obtenerProductos();
                
                if (productos.length === 0) {
                    mostrarResultado('‚ùå No hay productos en la base de datos', 'error');
                    return;
                }
                
                // Ordenar por ID descendente para obtener el √∫ltimo
                const ultimoProducto = productos.sort((a, b) => b.id - a.id)[0];
                
                // Establecer el ID en el input y verificar
                document.getElementById('productId').value = ultimoProducto.id;
                await verificarProducto();
                
            } catch (error) {
                mostrarResultado(`‚ùå Error buscando √∫ltimo producto: ${error.message}`, 'error');
            }
        }
        
        // Verificar autom√°ticamente el producto ID 33 al cargar
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîç Herramienta de verificaci√≥n de im√°genes cargada');
        });
    </script>
</body>
</html>
