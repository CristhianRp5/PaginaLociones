<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Panel Admin - Carga Imagen Real</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; font-weight: bold; }
        .status.success { background-color: #d4edda; color: #155724; }
        .status.error { background-color: #f8d7da; color: #721c24; }
        .status.info { background-color: #d1ecf1; color: #0c5460; }
        .log-container { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px; padding: 15px; margin: 10px 0; max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        
        /* Estilos del panel real */
        .tabs-container { margin: 20px 0; }
        .tab-buttons { display: flex; border-bottom: 1px solid #ddd; }
        .tab-btn { padding: 10px 20px; background: #f8f9fa; border: 1px solid #ddd; border-bottom: none; cursor: pointer; margin-right: 2px; }
        .tab-btn.active { background: white; border-bottom: 1px solid white; position: relative; top: 1px; }
        .tab-content { display: none; padding: 20px; border: 1px solid #ddd; border-top: none; }
        .tab-content.active { display: block; }
        
        .file-upload-area { border: 2px dashed #ccc; padding: 30px; text-align: center; border-radius: 8px; background: #fafafa; cursor: pointer; transition: all 0.3s; }
        .file-upload-area:hover { border-color: #007bff; background: #f0f8ff; }
        .file-upload-area.dragover { border-color: #007bff; background: #e7f3ff; }
        .file-upload-area.file-selected { border-color: #28a745; background: #f0fff0; }
        
        .file-input { display: none; }
        .file-upload-label { cursor: pointer; display: block; }
        
        .image-preview { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background: #f9f9f9; }
        .preview-image { max-width: 200px; max-height: 200px; border: 1px solid #ddd; border-radius: 4px; }
        
        .btn { padding: 8px 16px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        
        .counter-badge { display: inline-block; padding: 3px 8px; background: #007bff; color: white; border-radius: 12px; font-size: 12px; margin-left: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Panel Admin - Carga Imagen Real</h1>
        <p>Replica exacta del comportamiento del panel de administraci√≥n real.</p>
        
        <div class="test-section">
            <h3>üìä Monitoreo de Eventos</h3>
            <div>
                <span>Input Change: <span class="counter-badge" id="inputChangeCount">0</span></span>
                <span>Area Click: <span class="counter-badge" id="areaClickCount">0</span></span>
                <span>Tab Change: <span class="counter-badge" id="tabChangeCount">0</span></span>
                <span>Preview Called: <span class="counter-badge" id="previewCount">0</span></span>
            </div>
        </div>
        
        <div class="test-section">
            <div class="tabs-container">
                <div class="tab-buttons">
                    <button class="tab-btn active" data-tab="url" id="urlTab">üåê URL</button>
                    <button class="tab-btn" data-tab="file" id="fileTab">üìÅ Archivo Local</button>
                </div>
                
                <div class="tab-content active" id="url-tab">
                    <label for="imagen_url">URL de la imagen:</label>
                    <input type="url" id="imagen_url" class="form-control" placeholder="https://ejemplo.com/imagen.jpg">
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">Pega la URL de una imagen en l√≠nea</div>
                </div>
                
                <div class="tab-content" id="file-tab">
                    <div class="file-upload-area" id="fileUploadArea">
                        <input type="file" id="imagen_file" accept="image/*" class="file-input">
                        <div class="file-upload-label">
                            <i>üìÅ</i>
                            <span id="uploadText">Haz clic para seleccionar una imagen</span>
                            <div style="font-size: 12px; color: #666; margin-top: 5px;">JPG, PNG, WEBP (m√°x. 5MB)</div>
                        </div>
                    </div>
                </div>
                
                <div class="image-preview" id="imagePreview" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span><strong>Vista previa:</strong></span>
                        <button type="button" class="btn btn-danger" onclick="clearImagePreview()">üóëÔ∏è Limpiar</button>
                    </div>
                    <img id="previewImg" src="" alt="Vista previa" class="preview-image">
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>üîß Estado del Sistema</h3>
            <div id="systemState">
                <div><strong>Image Type:</strong> <span id="imageTypeDisplay">url</span></div>
                <div><strong>Image Data:</strong> <span id="imageDataDisplay">null</span></div>
                <div><strong>Events Configured:</strong> <span id="eventsConfiguredDisplay">false</span></div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>üìù Log de Eventos</h3>
            <div class="log-container" id="logContainer"></div>
            <button class="btn btn-primary" onclick="clearLog()">Limpiar Log</button>
            <button class="btn btn-success" onclick="testDuplicateClick()">üîÑ Test Click Duplicado</button>
        </div>
        
        <div class="test-section">
            <h3>üèÜ Resultados</h3>
            <div id="testResults">
                <div class="status info">Sistema inicializado. Prueba seleccionar una imagen.</div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales (simulando AdminPanel)
        let imageData = null;
        let imageType = 'url';
        let eventsConfigured = false;
        
        // Contadores
        let counters = {
            inputChange: 0,
            areaClick: 0,
            tabChange: 0,
            preview: 0
        };
        
        // Funci√≥n de logging
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            const color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : type === 'warning' ? '#ffc107' : '#007bff';
            logEntry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> <span style="color: ${color};">[${type.toUpperCase()}] ${message}</span>`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function updateCounter(type) {
            counters[type]++;
            document.getElementById(`${type}Count`).textContent = counters[type];
            updateSystemState();
        }
        
        function updateSystemState() {
            document.getElementById('imageTypeDisplay').textContent = imageType;
            document.getElementById('imageDataDisplay').textContent = imageData ? `${(imageData.length / 1024).toFixed(1)}KB` : 'null';
            document.getElementById('eventsConfiguredDisplay').textContent = eventsConfigured;
        }
        
        // Configurar tabs (simulando setupImageTabs del panel real)
        function setupImageTabs() {
            log('üñºÔ∏è Configurando tabs de imagen...');
            
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetTab = btn.dataset.tab;
                    updateCounter('tabChange');
                    log(`üñ±Ô∏è Click en tab: ${targetTab}`);
                    
                    // Remover active de todos los tabs
                    tabBtns.forEach(b => b.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    // Activar tab seleccionado
                    btn.classList.add('active');
                    const targetContent = document.getElementById(`${targetTab}-tab`);
                    if (targetContent) {
                        targetContent.classList.add('active');
                        log(`‚úÖ Tab ${targetTab} activado`);
                    }
                    
                    // Solo cambiar el tipo, NO limpiar la imagen previa
                    imageType = targetTab;
                    log(`üîÑ Tipo de imagen cambiado a: ${imageType}`);
                    updateSystemState();
                });
            });
            
            log('‚úÖ Tabs de imagen configurados');
        }
        
        // Configurar eventos (simulando setupEvents del panel real)
        function setupEvents() {
            if (eventsConfigured) {
                log('‚ö†Ô∏è Eventos ya configurados, omitiendo...', 'warning');
                return;
            }
            
            log('üîß Configurando eventos...');
            
            // Configurar evento de cambio para input de archivo de imagen
            const imageFileInput = document.getElementById('imagen_file');
            if (imageFileInput) {
                imageFileInput.addEventListener('change', (e) => {
                    updateCounter('inputChange');
                    log('üìÅ Evento change del input de archivo');
                    previewImageFromFile(e.target);
                });
            }
            
            // Configurar drag and drop para el √°rea de carga de archivos
            const fileUploadArea = document.getElementById('fileUploadArea');
            if (fileUploadArea) {
                // Configurar click en el √°rea para abrir selector de archivos
                fileUploadArea.addEventListener('click', (e) => {
                    updateCounter('areaClick');
                    log('üñ±Ô∏è Click en √°rea de carga');
                    
                    if (!fileUploadArea.classList.contains('dragover')) {
                        const fileInput = document.getElementById('imagen_file');
                        if (fileInput) {
                            log('üìÇ Abriendo selector de archivos...');
                            fileInput.click();
                        }
                    }
                });
                
                // Prevenir comportamiento por defecto del navegador
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    fileUploadArea.addEventListener(eventName, (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                    });
                });
                
                // Agregar clase visual cuando se arrastra sobre el √°rea
                ['dragenter', 'dragover'].forEach(eventName => {
                    fileUploadArea.addEventListener(eventName, () => {
                        fileUploadArea.classList.add('dragover');
                        log('üìÇ Drag over activado');
                    });
                });
                
                // Remover clase visual cuando se sale del √°rea
                ['dragleave', 'drop'].forEach(eventName => {
                    fileUploadArea.addEventListener(eventName, () => {
                        fileUploadArea.classList.remove('dragover');
                        log('üìÇ Drag over desactivado');
                    });
                });
                
                // Manejar el evento drop
                fileUploadArea.addEventListener('drop', (e) => {
                    const files = e.dataTransfer.files;
                    log(`üìÇ Archivos arrastrados: ${files.length}`);
                    
                    if (files.length > 0) {
                        // Simular selecci√≥n de archivo
                        const fileInput = document.getElementById('imagen_file');
                        if (fileInput) {
                            const dataTransfer = new DataTransfer();
                            dataTransfer.items.add(files[0]);
                            fileInput.files = dataTransfer.files;
                            
                            previewImageFromFile(fileInput);
                        }
                    }
                });
            }
            
            eventsConfigured = true;
            updateSystemState();
            log('‚úÖ Eventos configurados correctamente');
        }
        
        // Previsualizar imagen desde archivo (simulando previewImageFromFile del panel real)
        function previewImageFromFile(input) {
            updateCounter('preview');
            
            const file = input.files[0];
            const imagePreview = document.getElementById('imagePreview');
            const previewImg = document.getElementById('previewImg');
            const fileUploadArea = document.getElementById('fileUploadArea');
            
            log(`üìÅ Procesando archivo de imagen: ${file ? file.name : 'null'}`);
            
            if (!file) {
                log('‚ùå No se seleccion√≥ archivo');
                clearImagePreview();
                imageData = null;
                updateSystemState();
                return;
            }
            
            if (!file.type.startsWith('image/')) {
                log(`‚ùå Tipo de archivo inv√°lido: ${file.type}`, 'error');
                showResult('Por favor selecciona un archivo de imagen v√°lido', 'error');
                input.value = '';
                imageData = null;
                updateSystemState();
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                log(`‚ùå Archivo muy grande: ${(file.size / 1024 / 1024).toFixed(2)}MB`, 'error');
                showResult('La imagen es muy grande. M√°ximo 5MB', 'error');
                input.value = '';
                imageData = null;
                updateSystemState();
                return;
            }
            
            log(`‚úÖ Archivo v√°lido: ${file.name} (${(file.size / 1024).toFixed(1)}KB)`);
            
            // Agregar indicador visual de archivo seleccionado
            if (fileUploadArea) {
                fileUploadArea.classList.add('file-selected');
                const uploadText = document.getElementById('uploadText');
                if (uploadText) {
                    uploadText.textContent = `Archivo seleccionado: ${file.name}`;
                }
            }
            
            // Mostrar loading
            if (imagePreview && previewImg) {
                imagePreview.style.display = 'block';
                previewImg.src = '';
                previewImg.alt = 'Cargando archivo...';
                previewImg.style.opacity = '0.5';
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const imageDataResult = e.target.result;
                log(`‚úÖ Archivo le√≠do exitosamente`);
                log(`üìä Tama√±o de datos: ${imageDataResult ? imageDataResult.length : 0} caracteres`);
                
                if (previewImg) {
                    previewImg.src = imageDataResult;
                    previewImg.alt = `Preview de ${file.name}`;
                    previewImg.style.opacity = '1';
                }
                if (imagePreview) {
                    imagePreview.style.display = 'block';
                }
                
                // Guardar datos de imagen y establecer tipo
                imageData = imageDataResult;
                imageType = 'file';
                updateSystemState();
                
                log(`üìä Datos de imagen guardados correctamente: Tipo: ${imageType}, Tama√±o: ${(imageDataResult.length / 1024).toFixed(1)}KB`);
                showResult('‚úÖ Imagen cargada y procesada correctamente', 'success');
            };
            
            reader.onerror = () => {
                log(`‚ùå Error leyendo archivo: ${file.name}`, 'error');
                showResult('Error leyendo el archivo de imagen', 'error');
                input.value = '';
                imageData = null;
                updateSystemState();
                clearImagePreview();
            };
            
            reader.readAsDataURL(file);
        }
        
        // Limpiar preview
        function clearImagePreview() {
            log('üßπ Limpiando preview de imagen...');
            
            const imagePreview = document.getElementById('imagePreview');
            const previewImg = document.getElementById('previewImg');
            const fileUploadArea = document.getElementById('fileUploadArea');
            const uploadText = document.getElementById('uploadText');
            
            if (imagePreview) imagePreview.style.display = 'none';
            if (previewImg) {
                previewImg.src = '';
                previewImg.alt = '';
                previewImg.style.opacity = '1';
            }
            
            if (fileUploadArea) {
                fileUploadArea.classList.remove('file-selected');
            }
            if (uploadText) {
                uploadText.textContent = 'Haz clic para seleccionar una imagen';
            }
            
            // Limpiar input
            const fileInput = document.getElementById('imagen_file');
            if (fileInput) fileInput.value = '';
            
            imageData = null;
            updateSystemState();
            
            log('‚úÖ Preview limpiado');
        }
        
        function showResult(message, type) {
            const testResults = document.getElementById('testResults');
            testResults.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        function clearLog() {
            document.getElementById('logContainer').innerHTML = '';
        }
        
        // Test espec√≠fico para detectar clicks duplicados
        function testDuplicateClick() {
            log('üîÑ Iniciando test de click duplicado...', 'warning');
            
            const fileUploadArea = document.getElementById('fileUploadArea');
            if (fileUploadArea) {
                // Simular m√∫ltiples clicks r√°pidos
                for (let i = 0; i < 3; i++) {
                    setTimeout(() => {
                        log(`üñ±Ô∏è Click simulado ${i + 1}/3`);
                        fileUploadArea.click();
                    }, i * 100);
                }
                
                setTimeout(() => {
                    log('üìä Test de clicks duplicados completado. Revisa los contadores.', 'info');
                    if (counters.areaClick > 3) {
                        showResult('‚ö†Ô∏è Posible duplicaci√≥n de eventos detectada', 'error');
                    } else {
                        showResult('‚úÖ No se detectaron eventos duplicados', 'success');
                    }
                }, 500);
            }
        }
        
        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Iniciando test del panel de administraci√≥n...');
            setupImageTabs();
            setupEvents();
            updateSystemState();
            showResult('Sistema listo. Selecciona una imagen para probar.', 'info');
            log('‚úÖ Sistema inicializado correctamente');
        });
    </script>
</body>
</html>
