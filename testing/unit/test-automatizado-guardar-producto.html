<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Automatizado - Guardar Producto con Imagen Local</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; font-weight: bold; }
        .status.success { background-color: #d4edda; color: #155724; }
        .status.error { background-color: #f8d7da; color: #721c24; }
        .status.info { background-color: #d1ecf1; color: #0c5460; }
        .status.warning { background-color: #fff3cd; color: #856404; }
        .log-container { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px; padding: 15px; margin: 10px 0; max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 11px; }
        .btn { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        
        .step { padding: 10px; margin: 10px 0; border-left: 4px solid #007bff; background: #f8f9fa; }
        .step.active { border-left-color: #ffc107; background: #fff3cd; }
        .step.completed { border-left-color: #28a745; background: #d4edda; }
        .step.error { border-left-color: #dc3545; background: #f8d7da; }
        
        .progress-bar { width: 100%; height: 20px; background: #e9ecef; border-radius: 10px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: #007bff; transition: width 0.3s; }
        
        .preview-container { margin: 15px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background: #f9f9f9; text-align: center; }
        .preview-image { max-width: 200px; max-height: 200px; border: 1px solid #ddd; border-radius: 4px; }
        
        .data-preview { background: #f8f9fa; padding: 10px; border-radius: 4px; margin: 10px 0; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ Test Automatizado - Guardar Producto con Imagen Local</h1>
        <p>Este test simula autom√°ticamente todo el proceso de agregar un producto con imagen local, igual que en el panel real.</p>
        
        <div class="test-section">
            <h3>üéØ Progreso del Test</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
            </div>
            <div id="currentStep">Listo para iniciar...</div>
        </div>
        
        <div class="test-section">
            <h3>üìã Pasos del Proceso</h3>
            <div id="stepsContainer">
                <div class="step" id="step1">1. Generar imagen de prueba</div>
                <div class="step" id="step2">2. Simular selecci√≥n de archivo</div>
                <div class="step" id="step3">3. Procesar imagen con FileReader</div>
                <div class="step" id="step4">4. Validar datos de imagen</div>
                <div class="step" id="step5">5. Preparar datos del producto</div>
                <div class="step" id="step6">6. Simular env√≠o a Supabase</div>
                <div class="step" id="step7">7. Verificar resultado</div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>üñºÔ∏è Vista Previa de Imagen</h3>
            <div class="preview-container" id="previewContainer">
                <div>No hay imagen generada a√∫n</div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>üì¶ Datos del Producto</h3>
            <div class="data-preview" id="productDataPreview">Esperando datos...</div>
        </div>
        
        <div class="test-section">
            <h3>üîß Controles</h3>
            <button class="btn btn-success" onclick="startTest()" id="startBtn">üöÄ Iniciar Test Completo</button>
            <button class="btn btn-primary" onclick="stepByStep()" id="stepBtn">üë£ Paso a Paso</button>
            <button class="btn btn-warning" onclick="generateImageOnly()">üñºÔ∏è Solo Generar Imagen</button>
            <button class="btn btn-danger" onclick="resetTest()">üîÑ Resetear</button>
        </div>
        
        <div class="test-section">
            <h3>üìù Log Detallado</h3>
            <div class="log-container" id="logContainer"></div>
            <button class="btn btn-primary" onclick="clearLog()">Limpiar Log</button>
        </div>
        
        <div class="test-section">
            <h3>üéØ Resultado Final</h3>
            <div id="finalResult">
                <div class="status info">Ejecuta el test para ver los resultados...</div>
            </div>
        </div>
    </div>

    <script>
        let currentStepIndex = 0;
        let isStepByStep = false;
        let testImage = null;
        let imageData = null;
        let productData = null;
        
        const steps = [
            'Generar imagen de prueba',
            'Simular selecci√≥n de archivo', 
            'Procesar imagen con FileReader',
            'Validar datos de imagen',
            'Preparar datos del producto',
            'Simular env√≠o a Supabase',
            'Verificar resultado'
        ];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            const color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : type === 'warning' ? '#ffc107' : '#007bff';
            logEntry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> <span style="color: ${color};">[${type.toUpperCase()}] ${message}</span>`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function updateProgress(step) {
            const progress = (step / steps.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('currentStep').textContent = `Paso ${step}/${steps.length}: ${steps[step - 1] || 'Completado'}`;
            
            // Actualizar estados visuales de los pasos
            for (let i = 1; i <= steps.length; i++) {
                const stepElement = document.getElementById(`step${i}`);
                stepElement.className = 'step';
                if (i < step) {
                    stepElement.className += ' completed';
                } else if (i === step) {
                    stepElement.className += ' active';
                }
            }
        }
        
        function clearLog() {
            document.getElementById('logContainer').innerHTML = '';
        }
        
        function resetTest() {
            currentStepIndex = 0;
            isStepByStep = false;
            testImage = null;
            imageData = null;
            productData = null;
            
            updateProgress(0);
            document.getElementById('previewContainer').innerHTML = '<div>No hay imagen generada a√∫n</div>';
            document.getElementById('productDataPreview').textContent = 'Esperando datos...';
            document.getElementById('finalResult').innerHTML = '<div class="status info">Ejecuta el test para ver los resultados...</div>';
            
            log('üîÑ Test reseteado');
        }
        
        async function generateTestImage() {
            return new Promise((resolve) => {
                log('üñºÔ∏è Generando imagen de prueba...');
                
                const canvas = document.createElement('canvas');
                canvas.width = 300;
                canvas.height = 300;
                const ctx = canvas.getContext('2d');
                
                // Fondo gradiente elegante
                const gradient = ctx.createLinearGradient(0, 0, 300, 300);
                gradient.addColorStop(0, '#f8f9fa');
                gradient.addColorStop(0.5, '#e9ecef');
                gradient.addColorStop(1, '#dee2e6');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 300, 300);
                
                // Botella de perfume estilizada
                ctx.fillStyle = '#d4af37';
                ctx.fillRect(120, 80, 60, 140);
                
                // Reflejos en la botella
                ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.fillRect(125, 85, 10, 130);
                
                // Tapa dorada
                ctx.fillStyle = '#b8860b';
                ctx.fillRect(115, 60, 70, 25);
                
                // Highlight en la tapa
                ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
                ctx.fillRect(118, 63, 64, 6);
                
                // Etiqueta elegante
                ctx.fillStyle = 'white';
                ctx.fillRect(125, 100, 50, 80);
                
                // Borde de la etiqueta
                ctx.strokeStyle = '#d4af37';
                ctx.lineWidth = 1;
                ctx.strokeRect(125, 100, 50, 80);
                
                // Texto de la etiqueta
                ctx.fillStyle = '#333';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('TEST', 150, 120);
                
                ctx.font = '12px Arial';
                ctx.fillText('PERFUME', 150, 140);
                
                ctx.font = '10px Arial';
                ctx.fillText('Eau de', 150, 155);
                ctx.fillText('Toilette', 150, 167);
                
                ctx.font = 'bold 10px Arial';
                ctx.fillText('100ml', 150, 182);
                
                // Informaci√≥n del test
                ctx.font = '8px Arial';
                ctx.fillStyle = '#666';
                ctx.fillText(`Test: ${new Date().toLocaleTimeString()}`, 150, 280);
                
                // Convertir a blob
                canvas.toBlob((blob) => {
                    testImage = new File([blob], 'perfume-test.png', { type: 'image/png' });
                    
                    // Mostrar preview
                    const url = URL.createObjectURL(blob);
                    document.getElementById('previewContainer').innerHTML = `
                        <img src="${url}" class="preview-image" alt="Imagen de prueba">
                        <div style="margin-top: 10px; font-size: 12px;">
                            <strong>Archivo generado:</strong> ${testImage.name}<br>
                            <strong>Tama√±o:</strong> ${(testImage.size / 1024).toFixed(1)}KB<br>
                            <strong>Tipo:</strong> ${testImage.type}
                        </div>
                    `;
                    
                    log(`‚úÖ Imagen generada: ${testImage.name} (${(testImage.size / 1024).toFixed(1)}KB)`, 'success');
                    resolve(testImage);
                });
            });
        }
        
        async function processImageWithFileReader(file) {
            return new Promise((resolve, reject) => {
                log('üìÅ Procesando imagen con FileReader...');
                
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    imageData = e.target.result;
                    log(`‚úÖ Imagen procesada como base64`, 'success');
                    log(`üìä Tama√±o base64: ${(imageData.length / 1024).toFixed(1)}KB`);
                    log(`üìä Formato v√°lido: ${imageData.startsWith('data:image/') ? '‚úÖ' : '‚ùå'}`);
                    resolve(imageData);
                };
                
                reader.onerror = () => {
                    log('‚ùå Error procesando imagen con FileReader', 'error');
                    reject(new Error('Error procesando imagen'));
                };
                
                reader.readAsDataURL(file);
            });
        }
        
        function validateImageData() {
            log('üîç Validando datos de imagen...');
            
            if (!imageData) {
                log('‚ùå No hay datos de imagen', 'error');
                return false;
            }
            
            if (typeof imageData !== 'string') {
                log(`‚ùå Datos de imagen no son string: ${typeof imageData}`, 'error');
                return false;
            }
            
            if (!imageData.startsWith('data:image/')) {
                log('‚ùå Datos no son base64 v√°lido', 'error');
                return false;
            }
            
            if (imageData.length < 1000) {
                log('‚ùå Datos de imagen muy peque√±os (posiblemente corruptos)', 'error');
                return false;
            }
            
            log('‚úÖ Datos de imagen v√°lidos', 'success');
            log(`   - Tipo: string ‚úÖ`);
            log(`   - Formato base64: ‚úÖ`);
            log(`   - Tama√±o: ${(imageData.length / 1024).toFixed(1)}KB ‚úÖ`);
            
            return true;
        }
        
        function prepareProductData() {
            log('üì¶ Preparando datos del producto...');
            
            productData = {
                nombre: `Perfume Test ${new Date().getTime()}`,
                marca: 'Test Brand',
                precio: 75000,
                categoria: 'para-ellos',
                subcategoria: 'designer',
                descripcion: 'Perfume de prueba generado autom√°ticamente para testing',
                notas: 'Bergamota, Rosa, S√°ndalo',
                estado: 'disponible',
                descuento: null,
                activo: true
            };
            
            // Agregar imagen si est√° disponible
            if (imageData) {
                productData.imagen_url = imageData;
                log('‚úÖ Imagen agregada a los datos del producto', 'success');
            } else {
                log('‚ö†Ô∏è No hay imagen para agregar', 'warning');
            }
            
            // Mostrar datos en la UI
            document.getElementById('productDataPreview').innerHTML = `<pre>${JSON.stringify(productData, null, 2)}</pre>`;
            
            log('‚úÖ Datos del producto preparados', 'success');
            log(`üìã Campos: ${Object.keys(productData).length}`);
            log(`üìã Tiene imagen: ${productData.imagen_url ? '‚úÖ' : '‚ùå'}`);
            
            return productData;
        }
        
        async function simulateSupabaseSend() {
            log('üöÄ Simulando env√≠o a Supabase...', 'warning');
            
            if (!productData) {
                log('‚ùå No hay datos de producto para enviar', 'error');
                return null;
            }
            
            // Simular delay de red
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Simular validaci√≥n de Supabase
            const requiredFields = ['nombre', 'marca', 'precio', 'categoria'];
            const missingFields = requiredFields.filter(field => !productData[field]);
            
            if (missingFields.length > 0) {
                log(`‚ùå Campos requeridos faltantes: ${missingFields.join(', ')}`, 'error');
                return null;
            }
            
            // Simular respuesta de Supabase
            const simulatedResponse = {
                id: Math.floor(Math.random() * 1000) + 1,
                ...productData,
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };
            
            log('‚úÖ Respuesta simulada de Supabase recibida', 'success');
            log(`üìã Producto creado con ID: ${simulatedResponse.id}`);
            
            // Verificar que la imagen se "guard√≥"
            if (simulatedResponse.imagen_url) {
                log('üñºÔ∏è Imagen guardada en base de datos ‚úÖ', 'success');
                log(`   - Tama√±o en BD: ${(simulatedResponse.imagen_url.length / 1024).toFixed(1)}KB`);
            } else {
                log('‚ùå Imagen NO se guard√≥ en base de datos', 'error');
            }
            
            return simulatedResponse;
        }
        
        function verifyResult(result) {
            log('üîç Verificando resultado final...');
            
            let success = true;
            let issues = [];
            
            if (!result) {
                issues.push('No se recibi√≥ respuesta del guardado');
                success = false;
            } else {
                if (!result.id) {
                    issues.push('Producto sin ID asignado');
                    success = false;
                }
                
                if (!result.imagen_url) {
                    issues.push('Imagen no se guard√≥ en la base de datos');
                    success = false;
                }
                
                if (result.imagen_url && !result.imagen_url.startsWith('data:image/')) {
                    issues.push('Imagen guardada en formato incorrecto');
                    success = false;
                }
            }
            
            // Mostrar resultado final
            let resultHtml = '';
            if (success) {
                resultHtml = `
                    <div class="status success">
                        ‚úÖ <strong>TEST EXITOSO</strong><br>
                        El producto se guard√≥ correctamente con imagen local.
                    </div>
                    <div style="margin-top: 10px; font-size: 14px;">
                        <strong>Detalles:</strong><br>
                        ‚Ä¢ ID del producto: ${result.id}<br>
                        ‚Ä¢ Imagen guardada: ‚úÖ (${(result.imagen_url.length / 1024).toFixed(1)}KB)<br>
                        ‚Ä¢ Formato base64: ‚úÖ<br>
                        ‚Ä¢ Todos los campos: ‚úÖ
                    </div>
                `;
                log('üéâ TEST COMPLETADO EXITOSAMENTE', 'success');
            } else {
                resultHtml = `
                    <div class="status error">
                        ‚ùå <strong>TEST FALL√ì</strong><br>
                        Se encontraron problemas en el proceso.
                    </div>
                    <div style="margin-top: 10px; font-size: 14px;">
                        <strong>Problemas encontrados:</strong><br>
                        ${issues.map(issue => `‚Ä¢ ${issue}`).join('<br>')}
                    </div>
                `;
                log('‚ùå TEST FALL√ì - Ver problemas arriba', 'error');
            }
            
            document.getElementById('finalResult').innerHTML = resultHtml;
            return success;
        }
        
        async function executeStep(stepIndex) {
            currentStepIndex = stepIndex;
            updateProgress(stepIndex);
            
            try {
                switch (stepIndex) {
                    case 1:
                        await generateTestImage();
                        break;
                    case 2:
                        log('üìÅ Simulando selecci√≥n de archivo...');
                        if (!testImage) throw new Error('No hay imagen generada');
                        log(`‚úÖ Archivo seleccionado: ${testImage.name}`, 'success');
                        break;
                    case 3:
                        await processImageWithFileReader(testImage);
                        break;
                    case 4:
                        if (!validateImageData()) throw new Error('Validaci√≥n de imagen fall√≥');
                        break;
                    case 5:
                        prepareProductData();
                        break;
                    case 6:
                        const result = await simulateSupabaseSend();
                        if (!result) throw new Error('Env√≠o a Supabase fall√≥');
                        window.testResult = result; // Guardar para verificaci√≥n
                        break;
                    case 7:
                        verifyResult(window.testResult);
                        break;
                }
                
                if (!isStepByStep && stepIndex < steps.length) {
                    setTimeout(() => executeStep(stepIndex + 1), 1000);
                }
                
            } catch (error) {
                log(`‚ùå Error en paso ${stepIndex}: ${error.message}`, 'error');
                document.getElementById(`step${stepIndex}`).className = 'step error';
                
                document.getElementById('finalResult').innerHTML = `
                    <div class="status error">
                        ‚ùå <strong>ERROR EN PASO ${stepIndex}</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }
        
        async function startTest() {
            log('üöÄ Iniciando test completo automatizado...', 'warning');
            resetTest();
            isStepByStep = false;
            executeStep(1);
        }
        
        async function stepByStep() {
            if (currentStepIndex === 0) {
                log('üë£ Iniciando modo paso a paso...', 'warning');
                resetTest();
                isStepByStep = true;
                executeStep(1);
            } else if (currentStepIndex < steps.length) {
                executeStep(currentStepIndex + 1);
            } else {
                log('‚úÖ Todos los pasos completados');
            }
        }
        
        async function generateImageOnly() {
            log('üñºÔ∏è Generando solo imagen de prueba...');
            await generateTestImage();
            updateProgress(1);
        }
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            log('ü§ñ Sistema de test automatizado listo');
            resetTest();
        });
    </script>
</body>
</html>
