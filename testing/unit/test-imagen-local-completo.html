<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Carga Imagen Local - Diagn√≥stico Completo</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        .warning { background: #fff3cd; border-color: #ffeaa7; color: #856404; }
        .log { background: #f8f9fa; border: 1px solid #e9ecef; padding: 10px; margin: 10px 0; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; }
        button { background: #007bff; color: white; border: none; padding: 10px 15px; margin: 5px; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .file-input { margin: 10px 0; }
        .preview-img { max-width: 200px; max-height: 200px; border: 1px solid #ddd; margin: 10px 0; }
        .step { margin: 10px 0; padding: 10px; border-left: 4px solid #007bff; background: #f8f9fa; }
        .step.completed { border-left-color: #28a745; background: #d4edda; }
        .step.error { border-left-color: #dc3545; background: #f8d7da; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Completo - Carga de Imagen Local</h1>
        <p>Este test verifica todo el flujo de carga de imagen local desde la selecci√≥n hasta el guardado en base de datos.</p>
        
        <div class="test-section info">
            <h3>üìã Pasos del Test</h3>
            <div id="step1" class="step">1. Verificar dependencias (Supabase, ProductosService)</div>
            <div id="step2" class="step">2. Seleccionar archivo de imagen</div>
            <div id="step3" class="step">3. Verificar lectura y conversi√≥n a base64</div>
            <div id="step4" class="step">4. Simular guardado de producto con imagen</div>
            <div id="step5" class="step">5. Verificar almacenamiento en base de datos</div>
        </div>
        
        <div class="test-section">
            <h3>üîß Controles de Test</h3>
            <button onclick="testDependencies()">1. Verificar Dependencias</button>
            <input type="file" id="imageInput" accept="image/*" class="file-input" onchange="testFileReading()">
            <button onclick="testImageProcessing()">3. Test Procesamiento</button>
            <button onclick="testProductSave()">4. Test Guardado</button>
            <button onclick="testFullFlow()">üöÄ Test Completo</button>
            <button onclick="clearLog()">üßπ Limpiar Log</button>
        </div>
        
        <div class="test-section">
            <h3>üñºÔ∏è Preview de Imagen</h3>
            <div id="imagePreview"></div>
        </div>
        
        <div class="test-section">
            <h3>üìä Estado del Test</h3>
            <div id="testStatus">Esperando inicio del test...</div>
        </div>
        
        <div class="test-section">
            <h3>üìù Log Detallado</h3>
            <div id="logOutput" class="log">Test iniciado...</div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-config.js"></script>
    
    <script>
        let testImageData = null;
        let testResults = {
            dependencies: false,
            fileReading: false,
            imageProcessing: false,
            productSave: false,
            verification: false
        };

        function log(message, type = 'info') {
            const logOutput = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            const typeIcon = {
                'info': '‚ÑπÔ∏è',
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è'
            }[type] || '‚ÑπÔ∏è';
            
            logOutput.innerHTML += `${timestamp} ${typeIcon} ${message}\\n`;
            logOutput.scrollTop = logOutput.scrollHeight;
            console.log(`${typeIcon} ${message}`);
        }

        function updateStep(stepNum, status) {
            const step = document.getElementById(`step${stepNum}`);
            if (step) {
                step.className = `step ${status}`;
                if (status === 'completed') {
                    step.innerHTML = step.innerHTML.replace(/^\\d+\\./, `${stepNum}. ‚úÖ`);
                } else if (status === 'error') {
                    step.innerHTML = step.innerHTML.replace(/^\\d+\\./, `${stepNum}. ‚ùå`);
                }
            }
        }

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('testStatus');
            statusDiv.className = `test-section ${type}`;
            statusDiv.innerHTML = `<strong>${message}</strong>`;
        }

        function clearLog() {
            document.getElementById('logOutput').innerHTML = 'Log limpiado...\\n';
        }

        async function testDependencies() {
            log('üîç Verificando dependencias...');
            updateStatus('Verificando dependencias...', 'info');
            
            try {
                // Verificar Supabase
                const hasSupabase = typeof window.supabase !== 'undefined';
                log(`Supabase global: ${hasSupabase ? '‚úÖ' : '‚ùå'}`);
                
                // Verificar cliente
                const hasClient = typeof supabaseClient !== 'undefined' && supabaseClient !== null;
                log(`Supabase client: ${hasClient ? '‚úÖ' : '‚ùå'}`);
                
                // Verificar ProductosService
                const hasService = typeof ProductosService !== 'undefined';
                log(`ProductosService: ${hasService ? '‚úÖ' : '‚ùå'}`);
                
                if (hasSupabase && hasClient && hasService) {
                    // Test de conexi√≥n
                    const { data, error } = await supabaseClient
                        .from('productos')
                        .select('id')
                        .limit(1);
                    
                    if (error) {
                        throw new Error(`Error de conexi√≥n: ${error.message}`);
                    }
                    
                    log('‚úÖ Conexi√≥n a base de datos exitosa');
                    testResults.dependencies = true;
                    updateStep(1, 'completed');
                    updateStatus('Dependencias verificadas correctamente', 'success');
                } else {
                    throw new Error('Faltan dependencias cr√≠ticas');
                }
                
            } catch (error) {
                log(`‚ùå Error verificando dependencias: ${error.message}`, 'error');
                testResults.dependencies = false;
                updateStep(1, 'error');
                updateStatus('Error en verificaci√≥n de dependencias', 'error');
            }
        }

        async function testFileReading() {
            const fileInput = document.getElementById('imageInput');
            const file = fileInput.files[0];
            
            if (!file) {
                log('‚ùå No se seleccion√≥ archivo', 'error');
                updateStep(2, 'error');
                return;
            }
            
            log(`üìÅ Archivo seleccionado: ${file.name} (${(file.size / 1024).toFixed(1)}KB)`);
            updateStatus('Procesando archivo...', 'info');
            
            try {
                // Verificar tipo
                if (!file.type.startsWith('image/')) {
                    throw new Error(`Tipo de archivo inv√°lido: ${file.type}`);
                }
                
                // Verificar tama√±o
                if (file.size > 5 * 1024 * 1024) {
                    throw new Error(`Archivo muy grande: ${(file.size / 1024 / 1024).toFixed(2)}MB`);
                }
                
                // Leer archivo
                const reader = new FileReader();
                const imageData = await new Promise((resolve, reject) => {
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = () => reject(new Error('Error leyendo archivo'));
                    reader.readAsDataURL(file);
                });
                
                // Verificar datos
                if (!imageData || !imageData.startsWith('data:image/')) {
                    throw new Error('Datos de imagen inv√°lidos');
                }
                
                testImageData = imageData;
                log(`‚úÖ Archivo le√≠do exitosamente (${imageData.length} caracteres)`);
                log(`üìä Inicio de datos: ${imageData.substring(0, 50)}...`);
                
                // Mostrar preview
                const preview = document.getElementById('imagePreview');
                preview.innerHTML = `<img src="${imageData}" class="preview-img" alt="Preview">`;
                
                testResults.fileReading = true;
                updateStep(2, 'completed');
                updateStep(3, 'completed');
                updateStatus('Archivo procesado correctamente', 'success');
                
            } catch (error) {
                log(`‚ùå Error procesando archivo: ${error.message}`, 'error');
                testResults.fileReading = false;
                updateStep(2, 'error');
                updateStep(3, 'error');
                updateStatus('Error procesando archivo', 'error');
            }
        }

        async function testImageProcessing() {
            if (!testImageData) {
                log('‚ùå No hay datos de imagen para procesar', 'error');
                return;
            }
            
            log('üñºÔ∏è Verificando procesamiento de imagen...');
            
            try {
                // Simular el procesamiento que hace AdminPanel
                const imageSize = (testImageData.length / 1024).toFixed(1);
                const isValidBase64 = testImageData.startsWith('data:image/');
                
                log(`üìä Tama√±o de imagen: ${imageSize}KB`);
                log(`üìä Formato base64 v√°lido: ${isValidBase64 ? '‚úÖ' : '‚ùå'}`);
                
                if (isValidBase64) {
                    testResults.imageProcessing = true;
                    log('‚úÖ Procesamiento de imagen exitoso');
                    updateStatus('Imagen procesada correctamente', 'success');
                } else {
                    throw new Error('Formato de imagen inv√°lido');
                }
                
            } catch (error) {
                log(`‚ùå Error en procesamiento: ${error.message}`, 'error');
                testResults.imageProcessing = false;
                updateStatus('Error en procesamiento de imagen', 'error');
            }
        }

        async function testProductSave() {
            if (!testResults.dependencies) {
                log('‚ùå Dependencias no verificadas', 'error');
                return;
            }
            
            if (!testImageData) {
                log('‚ùå No hay imagen para guardar', 'error');
                return;
            }
            
            log('üíæ Testando guardado de producto con imagen...');
            updateStatus('Guardando producto de prueba...', 'info');
            
            try {
                const testProduct = {
                    nombre: `Test Imagen Local ${new Date().getTime()}`,
                    marca: 'Test Brand',
                    precio: 50000,
                    categoria: 'para-ellos',
                    descripcion: 'Producto de prueba con imagen local',
                    imagen_url: testImageData, // Enviar como imagen_url para que vaya a columna imagen
                    activo: true
                };
                
                log('üì§ Enviando producto a ProductosService...');
                log(`üìä Datos: ${testProduct.nombre}, ${testProduct.marca}, $${testProduct.precio}`);
                log(`üñºÔ∏è Imagen: ${testImageData.substring(0, 50)}... (${testImageData.length} chars)`);
                
                const result = await ProductosService.crearProducto(testProduct);
                
                if (result && result.id) {
                    log(`‚úÖ Producto guardado exitosamente: ID ${result.id}`);
                    log(`üìã Resultado completo:`, 'info');
                    log(JSON.stringify(result, null, 2));
                    
                    testResults.productSave = true;
                    updateStep(4, 'completed');
                    updateStatus('Producto guardado correctamente', 'success');
                    
                    // Verificar en base de datos
                    await testVerification(result.id);
                    
                } else {
                    throw new Error('No se recibi√≥ ID de producto guardado');
                }
                
            } catch (error) {
                log(`‚ùå Error guardando producto: ${error.message}`, 'error');
                testResults.productSave = false;
                updateStep(4, 'error');
                updateStatus('Error guardando producto', 'error');
            }
        }

        async function testVerification(productId) {
            log(`üîç Verificando producto en base de datos (ID: ${productId})...`);
            
            try {
                const { data, error } = await supabaseClient
                    .from('productos')
                    .select('*')
                    .eq('id', productId)
                    .single();
                
                if (error) {
                    throw new Error(`Error consultando producto: ${error.message}`);
                }
                
                if (data) {
                    log('‚úÖ Producto encontrado en base de datos');
                    log(`üìã Nombre: ${data.nombre}`);
                    log(`üìã Marca: ${data.marca}`);
                    log(`üìã Precio: $${data.precio}`);
                    
                    // Verificar imagen
                    const hasImagen = !!data.imagen;
                    const hasImagenUrl = !!data.imagen_url;
                    
                    log(`üñºÔ∏è Columna 'imagen': ${hasImagen ? '‚úÖ Presente' : '‚ùå Vac√≠a'}`);
                    log(`üîó Columna 'imagen_url': ${hasImagenUrl ? '‚úÖ Presente' : '‚ùå Vac√≠a'}`);
                    
                    if (hasImagen) {
                        const imagenSize = (data.imagen.length / 1024).toFixed(1);
                        const isValidFormat = data.imagen.startsWith('data:image/');
                        log(`üìä Tama√±o imagen guardada: ${imagenSize}KB`);
                        log(`üìä Formato v√°lido: ${isValidFormat ? '‚úÖ' : '‚ùå'}`);
                        
                        if (isValidFormat) {
                            testResults.verification = true;
                            updateStep(5, 'completed');
                            updateStatus('‚úÖ Test completo exitoso - Imagen guardada correctamente', 'success');
                        } else {
                            throw new Error('Imagen guardada en formato incorrecto');
                        }
                    } else {
                        throw new Error('Imagen no se guard√≥ en la base de datos');
                    }
                    
                } else {
                    throw new Error('Producto no encontrado en base de datos');
                }
                
            } catch (error) {
                log(`‚ùå Error en verificaci√≥n: ${error.message}`, 'error');
                testResults.verification = false;
                updateStep(5, 'error');
                updateStatus('Error en verificaci√≥n final', 'error');
            }
        }

        async function testFullFlow() {
            log('üöÄ Iniciando test completo del flujo de imagen local...');
            clearLog();
            
            // Reset de resultados
            testResults = {
                dependencies: false,
                fileReading: false,
                imageProcessing: false,
                productSave: false,
                verification: false
            };
            
            // Reset de steps
            for (let i = 1; i <= 5; i++) {
                updateStep(i, '');
            }
            
            try {
                // Paso 1: Dependencias
                await testDependencies();
                if (!testResults.dependencies) {
                    throw new Error('Fall√≥ verificaci√≥n de dependencias');
                }
                
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Verificar que hay archivo seleccionado
                const fileInput = document.getElementById('imageInput');
                if (!fileInput.files[0]) {
                    throw new Error('Por favor selecciona un archivo de imagen primero');
                }
                
                // Paso 2-3: Lectura de archivo
                await testFileReading();
                if (!testResults.fileReading) {
                    throw new Error('Fall√≥ lectura de archivo');
                }
                
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Paso 4-5: Guardado y verificaci√≥n
                await testProductSave();
                if (!testResults.productSave) {
                    throw new Error('Fall√≥ guardado de producto');
                }
                
                log('üéâ ¬°Test completo exitoso! La carga de im√°genes locales funciona correctamente.');
                
            } catch (error) {
                log(`‚ùå Test completo fall√≥: ${error.message}`, 'error');
                updateStatus('Test completo fall√≥', 'error');
            }
        }

        // Inicializaci√≥n
        window.addEventListener('DOMContentLoaded', async () => {
            log('üåê Test de carga de imagen local iniciado');
            await new Promise(resolve => setTimeout(resolve, 1000));
            log('üìã Esperando interacci√≥n del usuario...');
        });
    </script>
</body>
</html>
