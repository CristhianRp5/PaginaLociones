<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Edici√≥n de Productos</title>
    <link rel="stylesheet" href="css/admin-panel.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Italiana&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .test-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 2rem 0;
            padding: 1.5rem;
            border: 1px solid rgba(184,134,11,0.2);
            border-radius: 8px;
            background: rgba(245,245,240,0.3);
        }
        .test-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--color-text);
            border-bottom: 2px solid var(--color-gold);
            padding-bottom: 0.5rem;
        }
        .success { color: #27ae60; }
        .error { color: #e74c3c; }
        .warning { color: #f39c12; }
        .info { color: #3498db; }
    </style>
</head>
<body>
    <!-- Importar dependencias -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/admin-panel-new.js"></script>

    <div class="test-container">
        <h1 class="section-title">üß™ Test de Funcionalidades de Edici√≥n</h1>
        <p>Esta p√°gina prueba todas las funcionalidades de edici√≥n de productos del panel de administraci√≥n.</p>

        <!-- Test 1: Inicializaci√≥n -->
        <div class="test-section">
            <h2 class="test-title">1. Inicializaci√≥n del Panel</h2>
            <div id="test1-result">Iniciando...</div>
            <button onclick="runTest1()" class="btn btn-primary">
                <i class="fas fa-play"></i> Ejecutar Test
            </button>
        </div>

        <!-- Test 2: Creaci√≥n de Producto -->
        <div class="test-section">
            <h2 class="test-title">2. Crear Producto de Prueba</h2>
            <div id="test2-result">Listo para ejecutar</div>
            <button onclick="runTest2()" class="btn btn-primary">
                <i class="fas fa-plus"></i> Crear Producto
            </button>
        </div>

        <!-- Test 3: Edici√≥n de Producto -->
        <div class="test-section">
            <h2 class="test-title">3. Funciones de Edici√≥n</h2>
            <div id="test3-result">Listo para ejecutar</div>
            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                <button onclick="runTest3a()" class="btn btn-secondary">
                    <i class="fas fa-edit"></i> Test Editar
                </button>
                <button onclick="runTest3b()" class="btn btn-secondary">
                    <i class="fas fa-sync"></i> Test Actualizar
                </button>
                <button onclick="runTest3c()" class="btn btn-danger">
                    <i class="fas fa-trash"></i> Test Eliminar
                </button>
            </div>
        </div>

        <!-- Test 4: Estados y Descuentos -->
        <div class="test-section">
            <h2 class="test-title">4. Estados y Descuentos</h2>
            <div id="test4-result">Listo para ejecutar</div>
            
            <!-- Simulador de formulario -->
            <div style="margin-top: 1rem; padding: 1rem; background: white; border-radius: 6px;">
                <h4>Simulador de Estados:</h4>
                <div style="display: flex; gap: 1rem; align-items: center; margin: 1rem 0;">
                    <label for="test-estado">Estado:</label>
                    <select id="test-estado" onchange="testEstadoChange()">
                        <option value="disponible">Disponible</option>
                        <option value="agotado">Agotado</option>
                        <option value="proximo">Pr√≥ximamente</option>
                        <option value="oferta">En Oferta</option>
                    </select>
                </div>
                
                <div id="test-descuento-group" style="display: none; margin: 1rem 0; padding: 1rem; background: rgba(39, 174, 96, 0.1); border-radius: 6px;">
                    <label for="test-descuento">Descuento (%):</label>
                    <input type="number" id="test-descuento" min="1" max="99" value="20" onchange="testUpdatePrecio()">
                    <div style="margin-top: 0.5rem;">
                        <label for="test-precio">Precio:</label>
                        <input type="number" id="test-precio" value="100000" onchange="testUpdatePrecio()">
                    </div>
                    <div id="test-precio-info" style="margin-top: 1rem; font-size: 0.9rem;">
                        <!-- Aqu√≠ se mostrar√° la informaci√≥n del precio -->
                    </div>
                </div>
            </div>
            
            <button onclick="runTest4()" class="btn btn-primary">
                <i class="fas fa-calculator"></i> Test Estados
            </button>
        </div>

        <!-- Test 5: Funciones Auxiliares -->
        <div class="test-section">
            <h2 class="test-title">5. Funciones Auxiliares</h2>
            <div id="test5-result">Listo para ejecutar</div>
            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                <button onclick="runTest5a()" class="btn btn-secondary">
                    <i class="fas fa-tag"></i> Test Estados Badge
                </button>
                <button onclick="runTest5b()" class="btn btn-secondary">
                    <i class="fas fa-dollar-sign"></i> Test Precios
                </button>
                <button onclick="runTest5c()" class="btn btn-secondary">
                    <i class="fas fa-image"></i> Test Im√°genes
                </button>
            </div>
        </div>

        <!-- Logs -->
        <div class="test-section">
            <h2 class="test-title">üìã Logs de Ejecuci√≥n</h2>
            <pre id="test-logs" style="background: #2c3e50; color: #ecf0f1; padding: 1rem; border-radius: 6px; max-height: 300px; overflow-y: auto; font-size: 0.85rem;"></pre>
            <button onclick="clearLogs()" class="btn btn-secondary" style="margin-top: 0.5rem;">
                <i class="fas fa-trash"></i> Limpiar Logs
            </button>
        </div>
    </div>

    <script>
        let adminPanel;
        let testProductId = null;
        
        // Funci√≥n para agregar logs
        function addLog(message, type = 'info') {
            const logs = document.getElementById('test-logs');
            const timestamp = new Date().toLocaleTimeString();
            const icon = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            }[type] || '‚ÑπÔ∏è';
            
            logs.textContent += `[${timestamp}] ${icon} ${message}\n`;
            logs.scrollTop = logs.scrollHeight;
        }
        
        function clearLogs() {
            document.getElementById('test-logs').textContent = '';
        }
        
        // Test 1: Inicializaci√≥n
        async function runTest1() {
            const result = document.getElementById('test1-result');
            result.innerHTML = 'Ejecutando...';
            
            try {
                addLog('Iniciando test de inicializaci√≥n...', 'info');
                
                // Verificar dependencias
                const hasSupabase = typeof window.supabase !== 'undefined';
                const hasAdminPanel = typeof AdminPanel !== 'undefined';
                const hasProductosService = typeof ProductosService !== 'undefined';
                
                addLog(`Supabase: ${hasSupabase ? '‚úì' : '‚úó'}`, hasSupabase ? 'success' : 'error');
                addLog(`AdminPanel: ${hasAdminPanel ? '‚úì' : '‚úó'}`, hasAdminPanel ? 'success' : 'error');
                addLog(`ProductosService: ${hasProductosService ? '‚úì' : '‚úó'}`, hasProductosService ? 'success' : 'error');
                
                if (hasAdminPanel) {
                    // Crear instancia del panel
                    adminPanel = new AdminPanel();
                    await new Promise(resolve => setTimeout(resolve, 2000)); // Esperar inicializaci√≥n
                    
                    result.innerHTML = '<span class="success">‚úÖ Panel inicializado correctamente</span>';
                    addLog('Panel de administraci√≥n inicializado', 'success');
                } else {
                    result.innerHTML = '<span class="error">‚ùå AdminPanel no disponible</span>';
                    addLog('AdminPanel no est√° disponible', 'error');
                }
                
            } catch (error) {
                result.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
                addLog(`Error en inicializaci√≥n: ${error.message}`, 'error');
            }
        }
        
        // Test 2: Crear producto
        async function runTest2() {
            const result = document.getElementById('test2-result');
            result.innerHTML = 'Ejecutando...';
            
            try {
                addLog('Creando producto de prueba...', 'info');
                
                if (!adminPanel) {
                    throw new Error('Panel no inicializado. Ejecuta Test 1 primero.');
                }
                
                const testProduct = {
                    nombre: `Producto Test ${Date.now()}`,
                    marca: 'Test Brand',
                    precio: 50000,
                    categoria: 'para-ellos',
                    descripcion: 'Producto creado para testing',
                    estado: 'disponible',
                    activo: true
                };
                
                const created = await adminPanel.saveProduct(testProduct);
                testProductId = created.id;
                
                result.innerHTML = `<span class="success">‚úÖ Producto creado con ID: ${testProductId}</span>`;
                addLog(`Producto creado exitosamente con ID: ${testProductId}`, 'success');
                
            } catch (error) {
                result.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
                addLog(`Error creando producto: ${error.message}`, 'error');
            }
        }
        
        // Test 3a: Editar producto
        async function runTest3a() {
            const result = document.getElementById('test3-result');
            
            try {
                addLog('Testing funci√≥n editProduct...', 'info');
                
                if (!adminPanel || !testProductId) {
                    throw new Error('Necesitas crear un producto primero (Test 2)');
                }
                
                // Simular click en editar
                await adminPanel.editProduct(testProductId);
                
                result.innerHTML = '<span class="success">‚úÖ Funci√≥n editProduct ejecutada</span>';
                addLog('Funci√≥n editProduct ejecutada correctamente', 'success');
                
            } catch (error) {
                result.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
                addLog(`Error en editProduct: ${error.message}`, 'error');
            }
        }
        
        // Test 3b: Actualizar producto
        async function runTest3b() {
            const result = document.getElementById('test3-result');
            
            try {
                addLog('Testing funci√≥n updateProduct...', 'info');
                
                if (!adminPanel || !testProductId) {
                    throw new Error('Necesitas crear un producto primero (Test 2)');
                }
                
                const updateData = {
                    nombre: `Producto Actualizado ${Date.now()}`,
                    marca: 'Updated Brand',
                    precio: 75000,
                    categoria: 'para-ellos',
                    estado: 'oferta',
                    descuento: 15,
                    activo: true
                };
                
                const updated = await adminPanel.updateProduct(testProductId, updateData);
                
                result.innerHTML = '<span class="success">‚úÖ Producto actualizado</span>';
                addLog('Producto actualizado exitosamente', 'success');
                
            } catch (error) {
                result.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
                addLog(`Error actualizando producto: ${error.message}`, 'error');
            }
        }
        
        // Test 3c: Eliminar producto
        async function runTest3c() {
            const result = document.getElementById('test3-result');
            
            try {
                addLog('Testing funci√≥n deleteProduct...', 'info');
                
                if (!adminPanel || !testProductId) {
                    throw new Error('Necesitas crear un producto primero (Test 2)');
                }
                
                // Confirmar eliminaci√≥n autom√°ticamente para testing
                const originalConfirm = window.confirm;
                window.confirm = () => true;
                
                await adminPanel.deleteProduct(testProductId);
                
                // Restaurar confirm original
                window.confirm = originalConfirm;
                
                result.innerHTML = '<span class="success">‚úÖ Producto eliminado</span>';
                addLog('Producto eliminado exitosamente', 'success');
                testProductId = null; // Reset para pr√≥ximos tests
                
            } catch (error) {
                result.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
                addLog(`Error eliminando producto: ${error.message}`, 'error');
            }
        }
        
        // Test 4: Estados y descuentos
        function runTest4() {
            const result = document.getElementById('test4-result');
            
            try {
                addLog('Testing estados y descuentos...', 'info');
                
                if (!adminPanel) {
                    throw new Error('Panel no inicializado');
                }
                
                // Test badges de estado
                const estados = ['disponible', 'agotado', 'proximo', 'oferta'];
                let testResults = [];
                
                estados.forEach(estado => {
                    try {
                        const badge = adminPanel.getEstadoBadge(estado);
                        testResults.push(`${estado}: ‚úì`);
                        addLog(`Badge para estado "${estado}" generado correctamente`, 'success');
                    } catch (error) {
                        testResults.push(`${estado}: ‚úó`);
                        addLog(`Error generando badge para "${estado}": ${error.message}`, 'error');
                    }
                });
                
                result.innerHTML = `<span class="success">‚úÖ Estados testados: ${testResults.join(', ')}</span>`;
                
            } catch (error) {
                result.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
                addLog(`Error en test de estados: ${error.message}`, 'error');
            }
        }
        
        // Funciones auxiliares para el simulador de estados
        function testEstadoChange() {
            const estado = document.getElementById('test-estado').value;
            const descuentoGroup = document.getElementById('test-descuento-group');
            
            if (estado === 'oferta') {
                descuentoGroup.style.display = 'block';
                addLog('Campo de descuento mostrado para estado "oferta"', 'info');
            } else {
                descuentoGroup.style.display = 'none';
                addLog(`Campo de descuento ocultado para estado "${estado}"`, 'info');
            }
        }
        
        function testUpdatePrecio() {
            const precio = parseFloat(document.getElementById('test-precio').value) || 0;
            const descuento = parseFloat(document.getElementById('test-descuento').value) || 0;
            const precioInfo = document.getElementById('test-precio-info');
            
            if (precio > 0 && descuento > 0) {
                const precioFinal = precio - (precio * descuento / 100);
                precioInfo.innerHTML = `
                    <strong>Precio original:</strong> $${precio.toLocaleString()}<br>
                    <strong>Descuento:</strong> ${descuento}%<br>
                    <strong>Precio final:</strong> $${precioFinal.toLocaleString()}
                `;
                addLog(`Precio calculado: $${precio.toLocaleString()} -> $${precioFinal.toLocaleString()} (-${descuento}%)`, 'info');
            }
        }
        
        // Test 5: Funciones auxiliares
        function runTest5a() {
            addLog('Testing getEstadoBadge...', 'info');
            if (adminPanel) {
                const badge = adminPanel.getEstadoBadge('oferta');
                addLog('Badge generado: ' + badge, 'success');
            }
        }
        
        function runTest5b() {
            addLog('Testing getPrecioInfo...', 'info');
            if (adminPanel) {
                const producto = { precio: 100000, estado: 'oferta', descuento: 20 };
                const precio = adminPanel.getPrecioInfo(producto);
                addLog('Precio info generado correctamente', 'success');
            }
        }
        
        function runTest5c() {
            addLog('Testing funciones de imagen...', 'info');
            if (adminPanel) {
                adminPanel.clearImagePreview();
                addLog('clearImagePreview ejecutado', 'success');
            }
        }
        
        // Auto-inicializar cuando se cargue la p√°gina
        window.addEventListener('load', () => {
            addLog('P√°gina cargada, listo para testing', 'info');
            addLog('Ejecuta los tests en orden para mejores resultados', 'warning');
        });
    </script>
</body>
</html>
