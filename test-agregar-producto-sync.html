<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test: Agregar Producto y Sincronización</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        h1 {
            color: #4a5568;
            text-align: center;
            margin-bottom: 30px;
        }

        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: #f8fafc;
        }

        .test-section h3 {
            color: #2d3748;
            margin-top: 0;
        }

        .test-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: transform 0.2s;
        }

        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .status {
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            font-family: monospace;
        }

        .success {
            background: #f0fff4;
            border: 1px solid #68d391;
            color: #22543d;
        }

        .error {
            background: #fed7d7;
            border: 1px solid #fc8181;
            color: #742a2a;
        }

        .info {
            background: #e6fffa;
            border: 1px solid #4fd1c7;
            color: #234e52;
        }

        .warning {
            background: #fffbeb;
            border: 1px solid #f6e05e;
            color: #744210;
        }

        .log {
            background: #f7fafc;
            border: 1px solid #cbd5e0;
            padding: 10px;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }

        .product-test {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .product-card {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            background: white;
        }

        .product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .sync-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .sync-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .clear-btn {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .clear-btn:hover {
            background: #c53030;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🛒 Test: Agregar Producto y Sincronización del Carrito</h1>
        
        <div class="test-section">
            <h3>📋 Estado del Sistema</h3>
            <div id="systemStatus" class="status info">Verificando sistema...</div>
            <button class="test-button" onclick="checkSystemStatus()">🔍 Verificar Sistema</button>
        </div>

        <div class="test-section">
            <h3>🛍️ Productos de Prueba</h3>
            <div class="product-test">
                <div class="product-card">
                    <img src="IMAGENES/PARA_ELLAS.png" alt="Producto Para Ellas" class="product-image" onerror="this.src='https://via.placeholder.com/200x200?text=Para+Ellas'">
                    <h4>Perfume Elegance</h4>
                    <p><strong>Marca:</strong> Luxury</p>
                    <p><strong>Precio:</strong> $89.99</p>
                    <button class="test-button" onclick="addProductEllas()">➕ Agregar al Carrito</button>
                </div>
                
                <div class="product-card">
                    <img src="IMAGENES/PARA_ELLOS.png" alt="Producto Para Ellos" class="product-image" onerror="this.src='https://via.placeholder.com/200x200?text=Para+Ellos'">
                    <h4>Colonia Sport</h4>
                    <p><strong>Marca:</strong> Adventure</p>
                    <p><strong>Precio:</strong> $69.99</p>
                    <button class="test-button" onclick="addProductEllos()">➕ Agregar al Carrito</button>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>📊 Estado de Sincronización</h3>
            <div class="sync-status">
                <div class="sync-card">
                    <h4>💾 LocalStorage</h4>
                    <div id="localStorageStatus">-</div>
                    <button class="clear-btn" onclick="clearLocalStorage()">🗑️ Limpiar</button>
                </div>
                
                <div class="sync-card">
                    <h4>🧠 Memoria</h4>
                    <div id="memoryStatus">-</div>
                </div>
                
                <div class="sync-card">
                    <h4>🎯 Singleton</h4>
                    <div id="singletonStatus">-</div>
                </div>
                
                <div class="sync-card">
                    <h4>🔄 Sincronización</h4>
                    <div id="syncStatus">-</div>
                </div>
            </div>
            
            <button class="test-button" onclick="checkSyncStatus()">🔄 Verificar Sincronización</button>
            <button class="test-button" onclick="runCompleteTest()">🧪 Prueba Completa</button>
        </div>

        <div class="test-section">
            <h3>📝 Log de Eventos</h3>
            <div id="eventLog" class="log">Iniciando pruebas...</div>
            <button class="clear-btn" onclick="clearLog()">🗑️ Limpiar Log</button>
        </div>

        <div class="test-section">
            <h3>🎮 Acciones del Carrito</h3>
            <button class="test-button" onclick="showCart()">👁️ Mostrar Carrito</button>
            <button class="test-button" onclick="hideCart()">🙈 Ocultar Carrito</button>
            <button class="test-button" onclick="clearCart()">🗑️ Vaciar Carrito</button>
            <button class="test-button" onclick="limpiarProductosPrueba()">🧹 Limpiar Tests</button>
            <button class="test-button" onclick="getCartDetails()">📊 Detalles del Carrito</button>
        </div>

        <div class="test-section">
            <h3>🔍 Diagnóstico Avanzado</h3>
            <button class="test-button" onclick="runProblemDetection()">🔬 Detectar Problemas</button>
            <button class="test-button" onclick="runFullAnalysis()">📊 Análisis Completo</button>
            <button class="test-button" onclick="quickProblemCheck()">⚡ Verificación Rápida</button>
            <button class="test-button" onclick="runStressTest()">💪 Test de Estrés</button>
        </div>
    </div>

    <!-- Incluir scripts del carrito -->
    <script src="js/cart-error-fixes.js"></script>
    <script src="js/cart.js"></script>
    <script src="js/cart-sync-tester.js"></script>
    <script src="js/cart-add-product-analyzer.js"></script>
    <script src="js/cart-sync-problem-detector.js"></script>

    <script>
        // Variables globales para el test
        let logContainer = null;
        let testResults = {
            systemCheck: false,
            productAdd: false,
            syncVerify: false
        };

        // Productos de prueba
        const productEllas = {
            id: 'test-ellas-001',
            nombre: 'Perfume Elegance',
            marca: 'Luxury',
            precio: 89.99,
            categoria: 'para-ellas',
            imagen_url: 'IMAGENES/PARA_ELLAS.png',
            descripcion: 'Perfume elegante para mujeres'
        };

        const productEllos = {
            id: 'test-ellos-001',
            nombre: 'Colonia Sport',
            marca: 'Adventure',
            precio: 69.99,
            categoria: 'para-ellos',
            imagen_url: 'IMAGENES/PARA_ELLOS.png',
            descripcion: 'Colonia deportiva para hombres'
        };

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            logContainer = document.getElementById('eventLog');
            log('🚀 Test de sincronización iniciado');
            
            // Esperar a que el carrito se inicialice
            setTimeout(() => {
                checkSystemStatus();
            }, 1000);
        });

        // Función de logging
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            
            if (logContainer) {
                const div = document.createElement('div');
                div.textContent = logMessage;
                div.style.color = type === 'error' ? '#e53e3e' : 
                                 type === 'success' ? '#38a169' : 
                                 type === 'warning' ? '#d69e2e' : '#4a5568';
                logContainer.appendChild(div);
                logContainer.scrollTop = logContainer.scrollHeight;
            }
            
            console.log(logMessage);
        }

        // Verificar estado del sistema
        function checkSystemStatus() {
            log('🔍 Verificando estado del sistema...');
            
            const status = {
                cartExists: !!window.shoppingCart,
                cartInitialized: window.shoppingCart ? window.shoppingCart.isInitialized : false,
                singletonExists: typeof window.getShoppingCartInstance === 'function',
                errorFixerExists: typeof CartErrorFixer !== 'undefined',
                syncTesterExists: typeof CartSyncTester !== 'undefined'
            };

            let statusHTML = '';
            let allGood = true;

            for (const [key, value] of Object.entries(status)) {
                const icon = value ? '✅' : '❌';
                statusHTML += `${icon} ${key}: ${value}<br>`;
                if (!value) allGood = false;
            }

            const statusDiv = document.getElementById('systemStatus');
            statusDiv.innerHTML = statusHTML;
            statusDiv.className = `status ${allGood ? 'success' : 'error'}`;

            testResults.systemCheck = allGood;
            log(`📊 Estado del sistema: ${allGood ? 'COMPLETO' : 'INCOMPLETO'}`, allGood ? 'success' : 'error');

            if (allGood) {
                log(`🛒 Carrito disponible con ${window.shoppingCart.getTotalItems()} items`);
            }

            return allGood;
        }

        // Agregar producto para ellas
        function addProductEllas() {
            log('👩 Agregando producto para ellas...');
            addProductToCart(productEllas);
        }

        // Agregar producto para ellos
        function addProductEllos() {
            log('👨 Agregando producto para ellos...');
            addProductToCart(productEllos);
        }

        // Función genérica para agregar producto
        function addProductToCart(product) {
            try {
                if (!window.shoppingCart || !window.shoppingCart.isInitialized) {
                    throw new Error('Carrito no disponible o no inicializado');
                }

                log(`📦 Agregando: ${product.nombre} (ID: ${product.id})`);
                
                // Obtener estado previo
                const prevItems = window.shoppingCart.getTotalItems();
                const prevStorage = getLocalStorageItemCount();

                // Agregar producto
                window.shoppingCart.addItem(product);

                // Verificar inmediatamente
                setTimeout(() => {
                    const newItems = window.shoppingCart.getTotalItems();
                    const newStorage = getLocalStorageItemCount();

                    log(`📊 Items antes: ${prevItems}, después: ${newItems}`);
                    log(`💾 Storage antes: ${prevStorage}, después: ${newStorage}`);

                    if (newItems > prevItems && newStorage > prevStorage) {
                        log('✅ Producto agregado exitosamente', 'success');
                        testResults.productAdd = true;
                    } else {
                        log('❌ Error: Producto no se agregó correctamente', 'error');
                        testResults.productAdd = false;
                    }

                    checkSyncStatus();
                }, 200);

            } catch (error) {
                log(`❌ Error agregando producto: ${error.message}`, 'error');
                testResults.productAdd = false;
            }
        }

        // Verificar estado de sincronización
        function checkSyncStatus() {
            log('🔄 Verificando sincronización...');

            // Estado en memoria
            const memoryItems = window.shoppingCart ? window.shoppingCart.getTotalItems() : 0;
            const memoryData = window.shoppingCart ? window.shoppingCart.items : [];

            // Estado en localStorage
            const storageData = getLocalStorageData();
            const storageItems = storageData ? storageData.length : 0;

            // Estado del singleton
            let singletonItems = 0;
            try {
                if (window.getShoppingCartInstance) {
                    const cart = window.getShoppingCartInstance();
                    singletonItems = cart ? cart.getTotalItems() : 0;
                }
            } catch (error) {
                log(`⚠️ Error verificando singleton: ${error.message}`, 'warning');
            }

            // Actualizar UI
            document.getElementById('memoryStatus').innerHTML = `${memoryItems} items`;
            document.getElementById('localStorageStatus').innerHTML = `${storageItems} items`;
            document.getElementById('singletonStatus').innerHTML = `${singletonItems} items`;

            // Verificar sincronización
            const isSynced = (memoryItems === storageItems) && (memoryItems === singletonItems);
            const syncDiv = document.getElementById('syncStatus');
            syncDiv.innerHTML = isSynced ? '✅ Sincronizado' : '❌ Desincronizado';
            syncDiv.style.color = isSynced ? '#38a169' : '#e53e3e';

            testResults.syncVerify = isSynced;

            log(`🧠 Memoria: ${memoryItems} | 💾 Storage: ${storageItems} | 🎯 Singleton: ${singletonItems}`);
            log(`🔄 Sincronización: ${isSynced ? 'OK' : 'ERROR'}`, isSynced ? 'success' : 'error');

            if (!isSynced) {
                log('⚠️ Detectada desincronización entre componentes', 'warning');
                
                // Detalles de desincronización
                if (memoryItems !== storageItems) {
                    log(`💾 Discrepancia Memoria-Storage: ${memoryItems} vs ${storageItems}`, 'warning');
                }
                if (memoryItems !== singletonItems) {
                    log(`🎯 Discrepancia Memoria-Singleton: ${memoryItems} vs ${singletonItems}`, 'warning');
                }
            }

            return isSynced;
        }

        // Obtener datos del localStorage
        function getLocalStorageData() {
            try {
                const data = localStorage.getItem('shopping_cart');
                if (!data) return null;
                
                const parsed = JSON.parse(data);
                return Array.isArray(parsed) ? parsed : (parsed.items || []);
            } catch (error) {
                log(`❌ Error leyendo localStorage: ${error.message}`, 'error');
                return null;
            }
        }

        // Obtener cantidad de items en localStorage
        function getLocalStorageItemCount() {
            const data = getLocalStorageData();
            return data ? data.reduce((total, item) => total + (item.quantity || 1), 0) : 0;
        }

        // Prueba completa
        function runCompleteTest() {
            log('🧪 Iniciando prueba completa de sincronización...', 'info');
            
            // Reset resultados
            testResults = {
                systemCheck: false,
                productAdd: false,
                syncVerify: false
            };

            // Verificar sistema
            if (!checkSystemStatus()) {
                log('❌ Prueba abortada: Sistema no está completo', 'error');
                return;
            }

            // Limpiar carrito para empezar limpio
            if (window.shoppingCart) {
                window.shoppingCart.clearCart();
                log('🗑️ Carrito limpiado para prueba');
            }

            // Esperar y agregar productos de prueba
            setTimeout(() => {
                log('📦 Agregando productos de prueba...');
                addProductToCart(productEllas);
                
                setTimeout(() => {
                    addProductToCart(productEllos);
                    
                    setTimeout(() => {
                        const finalSync = checkSyncStatus();
                        
                        // Resultado final
                        const allPassed = testResults.systemCheck && testResults.productAdd && testResults.syncVerify;
                        log(`🏁 RESULTADO FINAL: ${allPassed ? 'ÉXITO' : 'FALLO'}`, allPassed ? 'success' : 'error');
                        
                        if (allPassed) {
                            log('✅ Todas las pruebas pasaron exitosamente', 'success');
                        } else {
                            log('❌ Algunas pruebas fallaron:', 'error');
                            log(`  - Sistema: ${testResults.systemCheck ? 'OK' : 'FALLO'}`);
                            log(`  - Agregar: ${testResults.productAdd ? 'OK' : 'FALLO'}`);
                            log(`  - Sync: ${testResults.syncVerify ? 'OK' : 'FALLO'}`);
                        }
                        
                    }, 500);
                }, 500);
            }, 500);
        }

        // Acciones del carrito
        function showCart() {
            if (window.shoppingCart) {
                window.shoppingCart.openCart();
                log('👁️ Carrito mostrado');
            }
        }

        function hideCart() {
            if (window.shoppingCart) {
                window.shoppingCart.closeCart();
                log('🙈 Carrito ocultado');
            }
        }

        function clearCart() {
            if (window.shoppingCart) {
                window.shoppingCart.clearCart();
                log('🗑️ Carrito vaciado');
                setTimeout(checkSyncStatus, 200);
            }
        }

        function getCartDetails() {
            if (window.shoppingCart) {
                const status = window.shoppingCart.getCartStatus();
                log('📊 Detalles del carrito:');
                log(`  - Total items: ${status.totalItems}`);
                log(`  - Total precio: $${status.totalPrice}`);
                log(`  - Productos únicos: ${status.uniqueProducts}`);
                log(`  - Estado: ${window.shoppingCart.isInitialized ? 'Inicializado' : 'No inicializado'}`);
            }
        }

        // Utiles
        function clearLocalStorage() {
            localStorage.removeItem('shopping_cart');
            log('💾 LocalStorage limpiado');
            setTimeout(checkSyncStatus, 200);
        }

        function clearLog() {
            if (logContainer) {
                logContainer.innerHTML = '';
            }
        }

        // Auto-verificar cada 5 segundos
        setInterval(checkSyncStatus, 5000);

        // Funciones de diagnóstico avanzado
        async function runProblemDetection() {
            log('🔬 Iniciando detección de problemas...', 'info');
            
            try {
                const analysis = await detectCartProblems();
                
                if (analysis.problems.length === 0) {
                    log('✅ No se detectaron problemas', 'success');
                } else {
                    log(`❌ Se detectaron ${analysis.problems.length} problemas`, 'error');
                    analysis.problems.forEach(problem => {
                        log(`  - ${problem.description}`, 'error');
                    });
                }
                
                if (analysis.warnings.length > 0) {
                    log(`⚠️ ${analysis.warnings.length} advertencias detectadas`, 'warning');
                }
                
            } catch (error) {
                log(`❌ Error durante detección: ${error.message}`, 'error');
            }
        }

        async function runFullAnalysis() {
            log('📊 Iniciando análisis completo...', 'info');
            
            try {
                const analysis = await analyzeAddProductFlow();
                
                if (analysis.summary.failed === 0) {
                    log('✅ Análisis completo exitoso', 'success');
                } else {
                    log(`❌ ${analysis.summary.failed} tests fallaron`, 'error');
                }
                
                log(`📈 Resumen: ${analysis.summary.passed} pasaron, ${analysis.summary.failed} fallaron`);
                
            } catch (error) {
                log(`❌ Error durante análisis: ${error.message}`, 'error');
            }
        }

        function runStressTest() {
            log('💪 Iniciando test de estrés...', 'info');
            
            const stressProducts = [];
            for (let i = 0; i < 10; i++) {
                stressProducts.push({
                    id: `stress-${i}-${Date.now()}`,
                    nombre: `Stress Product ${i}`,
                    marca: 'Stress Test',
                    precio: 10 + i,
                    categoria: 'stress'
                });
            }
            
            const startItems = window.shoppingCart.getTotalItems();
            log(`📦 Items iniciales: ${startItems}`);
            
            // Agregar productos rápidamente
            stressProducts.forEach((product, index) => {
                setTimeout(() => {
                    window.shoppingCart.addItem(product);
                    log(`➕ Agregado producto ${index + 1}/10`);
                    
                    if (index === stressProducts.length - 1) {
                        setTimeout(() => {
                            const finalItems = window.shoppingCart.getTotalItems();
                            const expected = startItems + stressProducts.length;
                            
                            if (finalItems === expected) {
                                log('✅ Test de estrés exitoso', 'success');
                            } else {
                                log(`❌ Test de estrés falló: esperado ${expected}, obtenido ${finalItems}`, 'error');
                            }
                            
                            checkSyncStatus();
                        }, 500);
                    }
                }, index * 50); // 50ms entre cada producto
            });
        }
    </script>
</body>
</html>
