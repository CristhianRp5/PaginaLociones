<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Sin Columnas Estado/Descuento</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .console-output {
            background: #1e1e1e;
            color: #ffffff;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-success { background: #d4edda; color: #155724; }
        .status-warning { background: #fff3cd; color: #856404; }
        .status-error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>üß™ Test - Funcionalidad sin Columnas Estado/Descuento</h1>
        <p class="text-muted">Esta p√°gina verifica que el sistema funcione correctamente cuando las columnas <code>estado</code> y <code>descuento</code> no existen en la tabla.</p>

        <!-- Estado de la conexi√≥n -->
        <div class="test-section">
            <h3>üîå Estado de la Conexi√≥n</h3>
            <div id="connection-status">Verificando conexi√≥n...</div>
        </div>

        <!-- Test de obtener productos -->
        <div class="test-section">
            <h3>üì¶ Test: Obtener Productos</h3>
            <button class="btn btn-primary" onclick="testObtenerProductos()">Ejecutar Test</button>
            <div id="productos-result" class="mt-3"></div>
        </div>

        <!-- Test de obtener producto por ID -->
        <div class="test-section">
            <h3>üîç Test: Obtener Producto por ID</h3>
            <div class="mb-2">
                <input type="number" id="product-id" class="form-control" placeholder="ID del producto" value="1">
            </div>
            <button class="btn btn-primary" onclick="testObtenerProductoPorId()">Ejecutar Test</button>
            <div id="producto-id-result" class="mt-3"></div>
        </div>

        <!-- Test de obtener productos por categor√≠a -->
        <div class="test-section">
            <h3>üè∑Ô∏è Test: Obtener Productos por Categor√≠a</h3>
            <div class="mb-2">
                <select id="categoria-select" class="form-control">
                    <option value="para-ellos">Para Ellos</option>
                    <option value="para-ellas">Para Ellas</option>
                    <option value="unisex">Unisex</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="testObtenerProductosPorCategoria()">Ejecutar Test</button>
            <div id="categoria-result" class="mt-3"></div>
        </div>

        <!-- Test de crear producto -->
        <div class="test-section">
            <h3>‚ûï Test: Crear Producto</h3>
            <button class="btn btn-success" onclick="testCrearProducto()">Crear Producto de Prueba</button>
            <div id="crear-result" class="mt-3"></div>
        </div>

        <!-- Test de actualizar producto -->
        <div class="test-section">
            <h3>‚úèÔ∏è Test: Actualizar Producto</h3>
            <div class="mb-2">
                <input type="number" id="update-product-id" class="form-control" placeholder="ID del producto a actualizar" value="1">
            </div>
            <button class="btn btn-warning" onclick="testActualizarProducto()">Actualizar Producto</button>
            <div id="actualizar-result" class="mt-3"></div>
        </div>

        <!-- Log Console -->
        <div class="test-section">
            <h3>üìù Log de Consola</h3>
            <button class="btn btn-secondary btn-sm" onclick="clearConsole()">Limpiar</button>
            <div id="console-output" class="console-output mt-2">Esperando logs...\n</div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>

    <script>
        // Configurar captura de logs
        const consoleOutput = document.getElementById('console-output');
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        function addToConsole(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'warn' ? '‚ö†Ô∏è' : 'üìã';
            consoleOutput.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            addToConsole(args.join(' '), 'log');
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addToConsole(args.join(' '), 'error');
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addToConsole(args.join(' '), 'warn');
        };

        function clearConsole() {
            consoleOutput.textContent = '';
        }

        function showResult(elementId, status, message, data = null) {
            const element = document.getElementById(elementId);
            const statusClass = status === 'success' ? 'status-success' : 
                               status === 'warning' ? 'status-warning' : 'status-error';
            
            let html = `<div class="status-badge ${statusClass}">${status.toUpperCase()}</div>`;
            html += `<div class="mt-2">${message}</div>`;
            
            if (data) {
                html += `<details class="mt-2">
                    <summary>Ver datos</summary>
                    <pre class="mt-2" style="background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto;">${JSON.stringify(data, null, 2)}</pre>
                </details>`;
            }
            
            element.innerHTML = html;
        }

        // Test functions
        async function testObtenerProductos() {
            try {
                console.log('üß™ Iniciando test: obtenerProductos()');
                const productos = await ProductosService.obtenerProductos();
                
                if (productos && productos.length > 0) {
                    const mensaje = `Se obtuvieron ${productos.length} productos correctamente.`;
                    showResult('productos-result', 'success', mensaje, productos.slice(0, 3));
                    console.log(`‚úÖ Test exitoso: ${mensaje}`);
                } else {
                    showResult('productos-result', 'warning', 'No se encontraron productos o retorn√≥ un array vac√≠o.', productos);
                    console.warn('‚ö†Ô∏è Test: No hay productos disponibles');
                }
            } catch (error) {
                showResult('productos-result', 'error', `Error al obtener productos: ${error.message}`, error);
                console.error('‚ùå Test fall√≥:', error);
            }
        }

        async function testObtenerProductoPorId() {
            try {
                const productId = document.getElementById('product-id').value;
                console.log(`üß™ Iniciando test: obtenerProductoPorId(${productId})`);
                
                const producto = await ProductosService.obtenerProductoPorId(parseInt(productId));
                
                if (producto) {
                    showResult('producto-id-result', 'success', 
                        `Producto encontrado: ${producto.nombre || 'Sin nombre'}`, producto);
                    console.log('‚úÖ Test exitoso: Producto obtenido');
                } else {
                    showResult('producto-id-result', 'warning', 
                        `No se encontr√≥ producto con ID ${productId}`, null);
                    console.warn('‚ö†Ô∏è Test: Producto no encontrado');
                }
            } catch (error) {
                showResult('producto-id-result', 'error', 
                    `Error al obtener producto: ${error.message}`, error);
                console.error('‚ùå Test fall√≥:', error);
            }
        }

        async function testObtenerProductosPorCategoria() {
            try {
                const categoria = document.getElementById('categoria-select').value;
                console.log(`üß™ Iniciando test: obtenerProductosPorCategoria("${categoria}")`);
                
                const productos = await ProductosService.obtenerProductosPorCategoria(categoria);
                
                if (productos && productos.length > 0) {
                    const mensaje = `Se encontraron ${productos.length} productos para "${categoria}".`;
                    showResult('categoria-result', 'success', mensaje, productos.slice(0, 2));
                    console.log(`‚úÖ Test exitoso: ${mensaje}`);
                } else {
                    showResult('categoria-result', 'warning', 
                        `No se encontraron productos para la categor√≠a "${categoria}".`, productos);
                    console.warn('‚ö†Ô∏è Test: No hay productos para esta categor√≠a');
                }
            } catch (error) {
                showResult('categoria-result', 'error', 
                    `Error al obtener productos por categor√≠a: ${error.message}`, error);
                console.error('‚ùå Test fall√≥:', error);
            }
        }

        async function testCrearProducto() {
            try {
                const nuevoProducto = {
                    nombre: `Producto Test ${Date.now()}`,
                    marca: 'Test Brand',
                    precio: 50000,
                    categoria: 'para-ellos',
                    descripcion: 'Producto de prueba para verificar funcionamiento sin columnas estado/descuento',
                    estado: 'disponible', // Este campo puede fallar si no existe
                    descuento: 10 // Este campo puede fallar si no existe
                };

                console.log('üß™ Iniciando test: crearProducto()');
                const resultado = await ProductosService.crearProducto(nuevoProducto);
                
                if (resultado && resultado.id) {
                    showResult('crear-result', 'success', 
                        `Producto creado exitosamente con ID: ${resultado.id}`, resultado);
                    console.log('‚úÖ Test exitoso: Producto creado');
                } else {
                    showResult('crear-result', 'warning', 
                        'Producto creado pero respuesta inesperada', resultado);
                    console.warn('‚ö†Ô∏è Test: Respuesta inesperada al crear producto');
                }
            } catch (error) {
                showResult('crear-result', 'error', 
                    `Error al crear producto: ${error.message}`, error);
                console.error('‚ùå Test fall√≥:', error);
            }
        }

        async function testActualizarProducto() {
            try {
                const productId = document.getElementById('update-product-id').value;
                const actualizacion = {
                    nombre: `Producto Actualizado ${Date.now()}`,
                    marca: 'Updated Brand',
                    precio: 75000,
                    categoria: 'para-ellos',
                    descripcion: 'Descripci√≥n actualizada para test',
                    estado: 'oferta', // Este campo puede fallar si no existe
                    descuento: 15 // Este campo puede fallar si no existe
                };

                console.log(`üß™ Iniciando test: updateProduct(${productId})`);
                const resultado = await ProductosService.updateProduct(parseInt(productId), actualizacion);
                
                if (resultado && resultado.id) {
                    showResult('actualizar-result', 'success', 
                        `Producto actualizado exitosamente. ID: ${resultado.id}`, resultado);
                    console.log('‚úÖ Test exitoso: Producto actualizado');
                } else {
                    showResult('actualizar-result', 'warning', 
                        'Producto actualizado pero respuesta inesperada', resultado);
                    console.warn('‚ö†Ô∏è Test: Respuesta inesperada al actualizar producto');
                }
            } catch (error) {
                showResult('actualizar-result', 'error', 
                    `Error al actualizar producto: ${error.message}`, error);
                console.error('‚ùå Test fall√≥:', error);
            }
        }

        // Verificar estado de conexi√≥n al cargar
        window.addEventListener('load', async () => {
            const connectionElement = document.getElementById('connection-status');
            
            try {
                if (typeof window.supabase === 'undefined' && typeof initSupabase === 'function') {
                    initSupabase();
                }
                
                if (typeof ProductosService === 'undefined') {
                    throw new Error('ProductosService no est√° disponible');
                }
                
                // Hacer una consulta simple para verificar conexi√≥n
                const productos = await ProductosService.obtenerProductos();
                
                connectionElement.innerHTML = `
                    <div class="status-badge status-success">CONECTADO</div>
                    <div class="mt-2">Supabase est√° configurado y funcionando. ProductosService disponible.</div>
                `;
                
                console.log('‚úÖ Conexi√≥n verificada exitosamente');
                
            } catch (error) {
                connectionElement.innerHTML = `
                    <div class="status-badge status-error">ERROR</div>
                    <div class="mt-2">Error de conexi√≥n: ${error.message}</div>
                `;
                
                console.error('‚ùå Error de conexi√≥n:', error);
            }
        });
    </script>
</body>
</html>
