<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico y Reparaci√≥n</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 20px auto; 
            padding: 20px;
            background: #f0f2f5;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 8px 5px;
            font-size: 14px;
        }
        
        button:hover { background: #2980b9; }
        
        .btn-danger { background: #e74c3c; }
        .btn-danger:hover { background: #c0392b; }
        
        .btn-success { background: #27ae60; }
        .btn-success:hover { background: #219a52; }
        
        .result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîß Diagn√≥stico y Reparaci√≥n Supabase</h1>
        <p>Soluciona problemas de estructura de la base de datos</p>
    </div>

    <div class="card">
        <h3>üìã Estado del Sistema</h3>
        <div id="system-status" class="status warning">Iniciando diagn√≥stico...</div>
        <button onclick="runDiagnostic()">üîç Ejecutar Diagn√≥stico Completo</button>
        <button onclick="window.open('https://xelobsbzytdxrrxgmlta.supabase.co/project/default/sql', '_blank')" class="btn-success">
            üìù Abrir SQL Editor
        </button>
    </div>

    <div class="card">
        <h3>üõ†Ô∏è Reparaciones R√°pidas</h3>
        <button onclick="recreateTable()" class="btn-danger">üîÑ Recrear Tabla Productos</button>
        <button onclick="addMissingColumns()">‚ûï Agregar Columnas Faltantes</button>
        <button onclick="insertSampleData()" class="btn-success">üì¶ Insertar Datos de Prueba</button>
        
        <div style="margin-top: 15px; padding: 10px; background: #e9ecef; border-radius: 5px;">
            <strong>üìã Script Manual:</strong> Si nada funciona, copia y pega 
            <code>fix-table-structure.sql</code> en el SQL Editor de Supabase.
        </div>
    </div>

    <div class="card">
        <h3>üìä Resultados</h3>
        <div id="results" class="result">Los resultados aparecer√°n aqu√≠...</div>
    </div>

    <script>
        const supabase = window.supabase.createClient(
            'https://xelobsbzytdxrrxgmlta.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhlbG9ic2J6eXRkeHJyeGdtbHRhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAzODUzNTksImV4cCI6MjA2NTk2MTM1OX0.bJL5DsL4pxlQ_FV3jX0ieiW3bYLA-Zf3M2HlNmdMMy4'
        );

        let resultsEl = document.getElementById('results');
        let statusEl = document.getElementById('system-status');

        function log(message) {
            resultsEl.textContent += new Date().toLocaleTimeString() + ' - ' + message + '\n';
            resultsEl.scrollTop = resultsEl.scrollHeight;
        }

        async function runDiagnostic() {
            resultsEl.textContent = '';
            log('üîç Iniciando diagn√≥stico completo...\n');

            // Test 1: Conexi√≥n b√°sica
            try {
                log('1Ô∏è‚É£ Probando conexi√≥n b√°sica...');
                const { data, error } = await supabase.auth.getSession();
                log('‚úÖ Conexi√≥n a Supabase OK');
            } catch (error) {
                log('‚ùå Error de conexi√≥n: ' + error.message);
                return;
            }

            // Test 2: Verificar si tabla productos existe
            try {
                log('\n2Ô∏è‚É£ Verificando tabla productos...');
                const { data, error } = await supabase
                    .from('productos')
                    .select('count')
                    .limit(1);

                if (error) {
                    if (error.code === '42P01') {
                        log('‚ùå Tabla productos NO EXISTE');
                        statusEl.className = 'status error';
                        statusEl.textContent = '‚ùå Tabla productos no existe - Necesita crearse';
                        return;
                    } else {
                        throw error;
                    }
                }
                log('‚úÖ Tabla productos existe');
            } catch (error) {
                log('‚ùå Error verificando tabla: ' + error.message);
                return;
            }

            // Test 3: Verificar estructura de columnas
            try {
                log('\n3Ô∏è‚É£ Probando columnas requeridas...');
                const columnas = ['nombre', 'marca', 'categoria', 'precio', 'imagen', 'descripcion'];
                let columnasFaltantes = [];

                for (const col of columnas) {
                    try {
                        const { data, error } = await supabase
                            .from('productos')
                            .select(col)
                            .limit(1);

                        if (error) {
                            columnasFaltantes.push(col);
                            log(`‚ùå Columna '${col}' falta o tiene error`);
                        } else {
                            log(`‚úÖ Columna '${col}' OK`);
                        }
                    } catch (err) {
                        columnasFaltantes.push(col);
                        log(`‚ùå Columna '${col}': ${err.message}`);
                    }
                }

                if (columnasFaltantes.length > 0) {
                    log(`\n‚ö†Ô∏è Columnas faltantes: ${columnasFaltantes.join(', ')}`);
                    statusEl.className = 'status warning';
                    statusEl.textContent = `‚ö†Ô∏è Faltan ${columnasFaltantes.length} columnas - Usar "Agregar Columnas Faltantes"`;
                } else {
                    log('\n‚úÖ Todas las columnas necesarias existen');
                    statusEl.className = 'status success';
                    statusEl.textContent = '‚úÖ Estructura correcta - Lista para usar';
                }

            } catch (error) {
                log('‚ùå Error verificando columnas: ' + error.message);
            }

            // Test 4: Intentar insertar producto de prueba
            try {
                log('\n4Ô∏è‚É£ Probando inserci√≥n de datos...');
                const testProduct = {
                    nombre: 'Test Product ' + Date.now(),
                    marca: 'Test Brand',
                    categoria: 'para-ellos',
                    precio: 99.99
                };

                const { data, error } = await supabase
                    .from('productos')
                    .insert([testProduct])
                    .select()
                    .single();

                if (error) {
                    log('‚ùå Error insertando: ' + error.message);
                    log('üí° C√≥digo de error: ' + error.code);
                } else {
                    log('‚úÖ Inserci√≥n de prueba exitosa');
                    log('üì¶ Producto creado: ' + data.nombre);
                }

            } catch (error) {
                log('‚ùå Error en test de inserci√≥n: ' + error.message);
            }

            log('\nüèÅ Diagn√≥stico completado');
        }

        async function recreateTable() {
            if (!confirm('‚ö†Ô∏è Esto eliminar√° la tabla productos y la recrear√°. ¬øContinuar?')) {
                return;
            }

            log('üîÑ Recreando tabla productos...');
            log('‚ùó IMPORTANTE: Ejecuta esto manualmente en el SQL Editor:');
            log(`
DROP TABLE IF EXISTS productos CASCADE;

CREATE TABLE productos (
    id BIGSERIAL PRIMARY KEY,
    nombre VARCHAR(255) NOT NULL,
    marca VARCHAR(255),
    categoria VARCHAR(255),
    precio DECIMAL(10,2) DEFAULT 0,
    imagen VARCHAR(500),
    descripcion TEXT,
    activo BOOLEAN DEFAULT true,
    disponible BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Habilitar RLS
ALTER TABLE productos ENABLE ROW LEVEL SECURITY;

-- Pol√≠tica de lectura p√∫blica
CREATE POLICY "allow_public_read" ON productos FOR SELECT USING (true);
CREATE POLICY "allow_public_insert" ON productos FOR INSERT WITH CHECK (true);
            `);
        }

        async function addMissingColumns() {
            log('‚ûï Para agregar columnas faltantes, ejecuta en SQL Editor:');
            log(`
-- Agregar columnas faltantes
ALTER TABLE productos ADD COLUMN IF NOT EXISTS categoria VARCHAR(255);
ALTER TABLE productos ADD COLUMN IF NOT EXISTS marca VARCHAR(255);
ALTER TABLE productos ADD COLUMN IF NOT EXISTS precio DECIMAL(10,2) DEFAULT 0;
ALTER TABLE productos ADD COLUMN IF NOT EXISTS imagen VARCHAR(500);
ALTER TABLE productos ADD COLUMN IF NOT EXISTS descripcion TEXT;
ALTER TABLE productos ADD COLUMN IF NOT EXISTS activo BOOLEAN DEFAULT true;
            `);
        }

        async function insertSampleData() {
            try {
                log('üì¶ Insertando datos de muestra...');
                
                const productos = [
                    {
                        nombre: '212 Men Carolina Herrera',
                        marca: 'Carolina Herrera',
                        categoria: 'para-ellos',
                        precio: 89000,
                        imagen: 'LOCIONES_PARA _ELLOS/212_CAROLINA_HERRERA.png',
                        descripcion: 'Fragancia fresca y urbana'
                    },
                    {
                        nombre: 'Versace Eros Blue',
                        marca: 'Versace', 
                        categoria: 'para-ellos',
                        precio: 120000,
                        imagen: 'LOCIONES_PARA _ELLOS/VERSACE_EROS_BLUE.png',
                        descripcion: 'Frescura mediterr√°nea'
                    }
                ];

                const { data, error } = await supabase
                    .from('productos')
                    .insert(productos)
                    .select();

                if (error) {
                    log('‚ùå Error insertando: ' + error.message);
                    log('üí° Soluci√≥n: Ejecuta fix-table-structure.sql primero');
                } else {
                    log('‚úÖ ' + data.length + ' productos insertados correctamente');
                }

            } catch (error) {
                log('‚ùå Error: ' + error.message);
            }
        }

        // Ejecutar diagn√≥stico al cargar
        window.addEventListener('load', runDiagnostic);
    </script>
</body>
</html>
