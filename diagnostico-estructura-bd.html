<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico - Estructura de Base de Datos</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .section h2 {
            color: #2c3e50;
            margin-top: 0;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #2980b9;
        }
        .btn-success {
            background: #27ae60;
        }
        .btn-success:hover {
            background: #219a52;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 12px;
        }
        .data-table th,
        .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            vertical-align: top;
        }
        .data-table th {
            background: #f4f4f4;
            font-weight: bold;
            position: sticky;
            top: 0;
        }
        .data-table tr:nth-child(even) {
            background: #f9f9f9;
        }
        .json-viewer {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            line-height: 1.4;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .log-container {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 4px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        .field-analysis {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .field-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        .field-name {
            font-weight: bold;
            color: #495057;
            margin-bottom: 5px;
        }
        .field-type {
            font-size: 11px;
            color: #6c757d;
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
            display: inline-block;
            margin-bottom: 5px;
        }
        .field-sample {
            font-family: monospace;
            font-size: 11px;
            color: #343a40;
            background: #ffffff;
            padding: 5px;
            border-radius: 3px;
            border: 1px solid #ced4da;
            word-break: break-all;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: #fff;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #ddd;
            text-align: center;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .sample-data {
            max-height: 300px;
            overflow-y: auto;
        }
        .null-indicator {
            color: #dc3545;
            font-style: italic;
        }
        .empty-indicator {
            color: #ffc107;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagn√≥stico de Estructura de Base de Datos</h1>
        
        <div class="section">
            <h2>üìä Estad√≠sticas Generales</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalRecords">-</div>
                    <div class="stat-label">Total Registros</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalFields">-</div>
                    <div class="stat-label">Campos Detectados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="activeRecords">-</div>
                    <div class="stat-label">Registros Activos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="withImages">-</div>
                    <div class="stat-label">Con Im√°genes</div>
                </div>
            </div>
            
            <button onclick="analyzeDatabase()">üîç Analizar Base de Datos</button>
            <button onclick="analyzeSampleData()">üìä Analizar Muestra</button>
            <button onclick="analyzeImageFields()">üñºÔ∏è Analizar Im√°genes</button>
            <button onclick="exportAnalysis()" class="btn-success">üìä Exportar An√°lisis</button>
        </div>

        <div class="section">
            <h2>üìã Estructura de Campos</h2>
            <div id="fieldAnalysis">
                <p>Ejecutar an√°lisis para ver la estructura de campos...</p>
            </div>
        </div>

        <div class="section">
            <h2>üì¶ Datos de Muestra (Raw)</h2>
            <div class="sample-data">
                <div class="json-viewer" id="rawData">
                    Ejecutar an√°lisis para ver datos de muestra...
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üñºÔ∏è An√°lisis de Campos de Imagen</h2>
            <div id="imageAnalysis">
                <p>Ejecutar an√°lisis de im√°genes para ver detalles...</p>
            </div>
        </div>

        <div class="section">
            <h2>üìä Tabla de Datos Detallada</h2>
            <div style="max-height: 400px; overflow-y: auto;">
                <div id="dataTable">
                    <p>Ejecutar an√°lisis para ver tabla de datos...</p>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üîß Recomendaciones de Optimizaci√≥n</h2>
            <div id="recommendations">
                <p>Las recomendaciones aparecer√°n despu√©s del an√°lisis...</p>
            </div>
        </div>

        <div class="section">
            <h2>üìù Log de An√°lisis</h2>
            <div class="log-container" id="analysisLog"></div>
            <button onclick="clearLog()">üßπ Limpiar Log</button>
        </div>
    </div>

    <script src="js/supabase-config-optimized.js"></script>
    <script>
        // Variables globales
        let analysisData = {
            records: [],
            fields: {},
            stats: {},
            imageFields: {},
            log: []
        };

        // Funci√≥n para logging
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            analysisData.log.push({ timestamp, message, type });
            
            const logContainer = document.getElementById('analysisLog');
            const logDiv = document.createElement('div');
            logDiv.textContent = logEntry;
            
            if (type === 'error') logDiv.style.color = '#e74c3c';
            else if (type === 'success') logDiv.style.color = '#27ae60';
            else if (type === 'warning') logDiv.style.color = '#f39c12';
            
            logContainer.appendChild(logDiv);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Funci√≥n para actualizar estad√≠sticas
        function updateStats() {
            document.getElementById('totalRecords').textContent = analysisData.records.length;
            document.getElementById('totalFields').textContent = Object.keys(analysisData.fields).length;
            document.getElementById('activeRecords').textContent = analysisData.stats.activeRecords || 0;
            document.getElementById('withImages').textContent = analysisData.stats.withImages || 0;
        }

        // Analizar base de datos completa
        async function analyzeDatabase() {
            log('üîç Iniciando an√°lisis completo de base de datos...');
            
            try {
                // Verificar conexi√≥n
                if (typeof supabaseClient === 'undefined') {
                    throw new Error('Cliente Supabase no disponible');
                }
                
                // Obtener todos los productos
                log('üì¶ Obteniendo todos los productos...');
                const { data, error } = await supabaseClient
                    .from('productos')
                    .select('*')
                    .order('id');
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    log('‚ö†Ô∏è No se encontraron productos en la base de datos', 'warning');
                    return;
                }
                
                analysisData.records = data;
                log(`‚úÖ ${data.length} productos obtenidos`, 'success');
                
                // Analizar estructura de campos
                analyzeFields(data);
                
                // Calcular estad√≠sticas
                calculateStats(data);
                
                // Actualizar UI
                updateStats();
                showFieldAnalysis();
                showRawData();
                showDataTable();
                generateRecommendations();
                
                log('‚úÖ An√°lisis completo finalizado', 'success');
                
            } catch (error) {
                log(`‚ùå Error en an√°lisis: ${error.message}`, 'error');
            }
        }

        // Analizar estructura de campos
        function analyzeFields(data) {
            log('üîç Analizando estructura de campos...');
            
            const fields = {};
            
            data.forEach(record => {
                Object.entries(record).forEach(([key, value]) => {
                    if (!fields[key]) {
                        fields[key] = {
                            name: key,
                            type: 'unknown',
                            nullCount: 0,
                            emptyCount: 0,
                            samples: [],
                            totalCount: 0
                        };
                    }
                    
                    const field = fields[key];
                    field.totalCount++;
                    
                    // Analizar tipo de dato
                    if (value === null) {
                        field.nullCount++;
                    } else if (value === '' || (typeof value === 'string' && value.trim() === '')) {
                        field.emptyCount++;
                    } else {
                        // Determinar tipo
                        const valueType = typeof value;
                        if (valueType === 'number') {
                            field.type = 'number';
                        } else if (valueType === 'boolean') {
                            field.type = 'boolean';
                        } else if (valueType === 'string') {
                            if (value.match(/^\d{4}-\d{2}-\d{2}/)) {
                                field.type = 'datetime';
                            } else if (value.startsWith('http')) {
                                field.type = 'url';
                            } else if (value.startsWith('data:image')) {
                                field.type = 'base64_image';
                            } else {
                                field.type = 'string';
                            }
                        }
                        
                        // Guardar muestra si no tenemos muchas
                        if (field.samples.length < 3) {
                            field.samples.push(value);
                        }
                    }
                });
            });
            
            analysisData.fields = fields;
            log(`‚úÖ ${Object.keys(fields).length} campos analizados`, 'success');
        }

        // Calcular estad√≠sticas
        function calculateStats(data) {
            log('üìä Calculando estad√≠sticas...');
            
            const stats = {
                totalRecords: data.length,
                activeRecords: 0,
                withImages: 0,
                categories: new Set(),
                brands: new Set(),
                priceRange: { min: Infinity, max: -Infinity }
            };
            
            data.forEach(record => {
                // Registros activos
                if (record.activo !== false) {
                    stats.activeRecords++;
                }
                
                // Registros con im√°genes
                if (record.imagen || record.imagen_url || record.imagen_principal) {
                    stats.withImages++;
                }
                
                // Categor√≠as
                if (record.categoria) {
                    stats.categories.add(record.categoria);
                }
                
                // Marcas
                if (record.marca) {
                    stats.brands.add(record.marca);
                }
                
                // Rango de precios
                if (record.precio && typeof record.precio === 'number') {
                    stats.priceRange.min = Math.min(stats.priceRange.min, record.precio);
                    stats.priceRange.max = Math.max(stats.priceRange.max, record.precio);
                }
            });
            
            stats.categoriesCount = stats.categories.size;
            stats.brandsCount = stats.brands.size;
            
            analysisData.stats = stats;
            log('‚úÖ Estad√≠sticas calculadas', 'success');
        }

        // Mostrar an√°lisis de campos
        function showFieldAnalysis() {
            const container = document.getElementById('fieldAnalysis');
            
            let html = '<div class="field-analysis">';
            
            Object.entries(analysisData.fields).forEach(([fieldName, field]) => {
                const nullPercentage = ((field.nullCount / field.totalCount) * 100).toFixed(1);
                const emptyPercentage = ((field.emptyCount / field.totalCount) * 100).toFixed(1);
                
                html += `
                    <div class="field-card">
                        <div class="field-name">${fieldName}</div>
                        <div class="field-type">${field.type}</div>
                        <div style="font-size: 11px; margin-bottom: 5px;">
                            Null: ${nullPercentage}% | Vac√≠o: ${emptyPercentage}%
                        </div>
                        <div class="field-sample">
                            ${field.samples.length > 0 ? 
                                field.samples.map(sample => 
                                    typeof sample === 'string' && sample.length > 50 ? 
                                        sample.substring(0, 50) + '...' : 
                                        sample
                                ).join('<br>') : 
                                'Sin muestras'
                            }
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Mostrar datos en bruto
        function showRawData() {
            const container = document.getElementById('rawData');
            
            // Mostrar primeros 3 registros con formato
            const sampleData = analysisData.records.slice(0, 3);
            container.textContent = JSON.stringify(sampleData, null, 2);
        }

        // Mostrar tabla de datos
        function showDataTable() {
            const container = document.getElementById('dataTable');
            
            if (analysisData.records.length === 0) {
                container.innerHTML = '<p>No hay datos para mostrar</p>';
                return;
            }
            
            // Obtener todas las claves
            const allKeys = Object.keys(analysisData.fields);
            
            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            ${allKeys.map(key => `<th>${key}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // Mostrar primeros 10 registros
            analysisData.records.slice(0, 10).forEach(record => {
                html += '<tr>';
                allKeys.forEach(key => {
                    let value = record[key];
                    let cellClass = '';
                    
                    if (value === null) {
                        value = '<span class="null-indicator">NULL</span>';
                    } else if (value === '' || (typeof value === 'string' && value.trim() === '')) {
                        value = '<span class="empty-indicator">EMPTY</span>';
                    } else if (typeof value === 'string' && value.length > 100) {
                        value = value.substring(0, 100) + '...';
                    }
                    
                    html += `<td>${value}</td>`;
                });
                html += '</tr>';
            });
            
            html += `
                    </tbody>
                </table>
                <p><small>Mostrando primeros 10 registros de ${analysisData.records.length} total</small></p>
            `;
            
            container.innerHTML = html;
        }

        // Analizar campos de imagen espec√≠ficamente
        async function analyzeImageFields() {
            log('üñºÔ∏è Analizando campos de imagen...');
            
            if (analysisData.records.length === 0) {
                log('‚ö†Ô∏è Ejecutar an√°lisis general primero', 'warning');
                return;
            }
            
            const imageAnalysis = {
                imagen: { total: 0, valid: 0, base64: 0, url: 0, null: 0, empty: 0 },
                imagen_url: { total: 0, valid: 0, base64: 0, url: 0, null: 0, empty: 0 },
                imagen_principal: { total: 0, valid: 0, base64: 0, url: 0, null: 0, empty: 0 }
            };
            
            analysisData.records.forEach(record => {
                ['imagen', 'imagen_url', 'imagen_principal'].forEach(field => {
                    if (record.hasOwnProperty(field)) {
                        imageAnalysis[field].total++;
                        
                        const value = record[field];
                        if (value === null) {
                            imageAnalysis[field].null++;
                        } else if (value === '' || (typeof value === 'string' && value.trim() === '')) {
                            imageAnalysis[field].empty++;
                        } else if (typeof value === 'string') {
                            imageAnalysis[field].valid++;
                            
                            if (value.startsWith('data:image')) {
                                imageAnalysis[field].base64++;
                            } else if (value.startsWith('http')) {
                                imageAnalysis[field].url++;
                            }
                        }
                    }
                });
            });
            
            // Mostrar an√°lisis de im√°genes
            const container = document.getElementById('imageAnalysis');
            let html = '<div class="field-analysis">';
            
            Object.entries(imageAnalysis).forEach(([field, stats]) => {
                if (stats.total > 0) {
                    html += `
                        <div class="field-card">
                            <div class="field-name">${field}</div>
                            <div class="field-type">image_field</div>
                            <div style="font-size: 11px;">
                                Total: ${stats.total}<br>
                                V√°lidas: ${stats.valid} (${((stats.valid/stats.total)*100).toFixed(1)}%)<br>
                                Base64: ${stats.base64}<br>
                                URLs: ${stats.url}<br>
                                Null: ${stats.null}<br>
                                Vac√≠as: ${stats.empty}
                            </div>
                        </div>
                    `;
                }
            });
            
            html += '</div>';
            container.innerHTML = html;
            
            log('‚úÖ An√°lisis de im√°genes completado', 'success');
        }

        // Analizar datos de muestra
        async function analyzeSampleData() {
            log('üìä Analizando datos de muestra...');
            
            try {
                // Obtener muestra m√°s peque√±a para an√°lisis r√°pido
                const { data, error } = await supabaseClient
                    .from('productos')
                    .select('*')
                    .limit(5);
                
                if (error) throw error;
                
                log(`‚úÖ Muestra de ${data.length} productos obtenida`, 'success');
                
                // Mostrar estructura detallada
                const container = document.getElementById('rawData');
                container.textContent = JSON.stringify(data, null, 2);
                
                // Analizar campos r√°pidamente
                if (data.length > 0) {
                    analyzeFields(data);
                    showFieldAnalysis();
                }
                
            } catch (error) {
                log(`‚ùå Error obteniendo muestra: ${error.message}`, 'error');
            }
        }

        // Generar recomendaciones
        function generateRecommendations() {
            const container = document.getElementById('recommendations');
            
            let recommendations = [];
            
            // Analizar campos de imagen
            const imageFields = ['imagen', 'imagen_url', 'imagen_principal'];
            const existingImageFields = imageFields.filter(field => analysisData.fields[field]);
            
            if (existingImageFields.length > 1) {
                recommendations.push({
                    type: 'warning',
                    title: 'M√∫ltiples campos de imagen',
                    description: `Se detectaron ${existingImageFields.length} campos de imagen: ${existingImageFields.join(', ')}. Considerar unificar en un solo campo.`
                });
            }
            
            // Analizar campos null/empty
            Object.entries(analysisData.fields).forEach(([fieldName, field]) => {
                const nullPercentage = (field.nullCount / field.totalCount) * 100;
                const emptyPercentage = (field.emptyCount / field.totalCount) * 100;
                
                if (nullPercentage > 50) {
                    recommendations.push({
                        type: 'info',
                        title: `Campo ${fieldName} con muchos valores null`,
                        description: `${nullPercentage.toFixed(1)}% de los registros tienen null en este campo.`
                    });
                }
                
                if (emptyPercentage > 20) {
                    recommendations.push({
                        type: 'warning',
                        title: `Campo ${fieldName} con valores vac√≠os`,
                        description: `${emptyPercentage.toFixed(1)}% de los registros tienen valores vac√≠os en este campo.`
                    });
                }
            });
            
            // Recomendaciones de optimizaci√≥n
            if (analysisData.stats.withImages < analysisData.stats.totalRecords * 0.8) {
                recommendations.push({
                    type: 'info',
                    title: 'Productos sin im√°genes',
                    description: `${analysisData.stats.totalRecords - analysisData.stats.withImages} productos no tienen im√°genes asignadas.`
                });
            }
            
            // Mostrar recomendaciones
            let html = '';
            if (recommendations.length === 0) {
                html = '<div class="status success">‚úÖ No se encontraron problemas significativos en la estructura de datos.</div>';
            } else {
                recommendations.forEach(rec => {
                    html += `
                        <div class="status ${rec.type}">
                            <strong>${rec.title}</strong><br>
                            ${rec.description}
                        </div>
                    `;
                });
            }
            
            container.innerHTML = html;
        }

        // Exportar an√°lisis
        function exportAnalysis() {
            const analysis = {
                timestamp: new Date().toISOString(),
                summary: {
                    totalRecords: analysisData.records.length,
                    totalFields: Object.keys(analysisData.fields).length,
                    activeRecords: analysisData.stats.activeRecords,
                    withImages: analysisData.stats.withImages
                },
                fields: analysisData.fields,
                stats: analysisData.stats,
                sampleData: analysisData.records.slice(0, 3)
            };
            
            const blob = new Blob([JSON.stringify(analysis, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `analisis-estructura-bd-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
            log('üìä An√°lisis exportado');
        }

        // Limpiar log
        function clearLog() {
            analysisData.log = [];
            document.getElementById('analysisLog').innerHTML = '';
            log('üßπ Log limpiado');
        }

        // Inicializar
        window.addEventListener('load', () => {
            log('üöÄ Diagn√≥stico de estructura de BD iniciado');
        });
    </script>
</body>
</html>
